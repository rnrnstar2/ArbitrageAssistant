# Hedge System 要件定義書 (MVP版)

## 1. システム概要

### 1.1 プロジェクト概要
- **プロジェクト名**: ArbitrageAssistant - Hedge System (MVP)
- **目的**: 海外FX業者のボーナスを活用したアービトラージ取引システム
- **特徴**: 複数口座・複数業者間での両建て管理により、出金拒否リスクを回避しながら利益を追求
- **MVP方針**: 最小限の機能で早期リリース、安全性と簡潔性を重視

### 1.2 システム構成
```
┌─────────────────────────────────────────────────────────────┐
│                      管理者側 (AWS)                           │
│  ┌─────────────┐  ┌─────────────┐  ┌──────────────────┐  │
│  │  Admin App  │  │  AppSync    │  │    DynamoDB      │  │
│  │  (Next.js)  │  │  (GraphQL)  │  │                  │  │
│  │  (メイン管理)│  │             │  │                  │  │
│  └─────────────┘  └─────────────┘  └──────────────────┘  │
│         ↑                ↑                                   │
└─────────┼────────────────┼───────────────────────────────────┘
          │   WebSocket    │
          │   (指令・データ)|
┌─────────┼────────────────┼───────────────────────────────────┐
│         ↓                ↓          クライアントPC           │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │Hedge System │←→│  MT4/MT5    │←→│  MT4/MT5    │        │
│  │  (Tauri)    │  │  + EA #1    │  │  + EA #2    │  ...   │
│  │ (指令実行   │  └─────────────┘  └─────────────┘        │
│  │  エンジン)  │  ┌─────────────┐  ┌─────────────┐        │
│  └─────────────┘←→│  MT4/MT5    │←→│  MT4/MT5    │        │
│                    │  + EA #3    │  │  + EA #4    │  ...   │
│                    └─────────────┘  └─────────────┘        │
└──────────────────────────────────────────────────────────────┘
```

### 1.3 役割分担
- **Admin App**: メイン管理画面、指令送信、データ監視・分析、統計・レポート
- **Hedge System (MVP版)**: 
  - **複数MT4/MT5との同時接続管理** (1クライアントPC: 3-6証券会社対応)
  - **Adminからの指令実行エンジン** (エントリー、決済のみ)
  - **リアルタイムデータ収集・送信** (ポジション、残高、ボーナス等)
  - **基本的なローカル状態監視**

## 2. 機能要件

### 2.1 コア機能

#### 2.1.1 アカウント管理
- **Admin**: クライアントごとのアカウント作成・管理画面
- **Hedge System**: 1クライアントPCあたり3-6証券会社のMT4/MT5への同時接続管理
- 証券会社ごとの認証情報セキュア保存
- **重要**: Hedge SystemはAdminからの指令を受けて複数MT4/MT5を制御する

#### 2.1.2 EA連携機能
- **推奨実装方式**: WebSocket経由での双方向通信
  - EA側：MQL5のWebRequestまたはDLL経由でWebSocketクライアント実装
  - リアルタイムデータ送信：ポジション情報、残高、ボーナス額、ロスカット通知
  - コマンド受信：エントリー、決済、トレール設定
- **データフォーマット**: JSON形式でのメッセージ交換
- **接続管理**: 自動再接続、ハートビート機能

#### 2.1.3 トレード管理
- **エントリー機能**
  - 管理画面からの手動エントリー（価格、ロット数指定）
  - エントリー情報の保存と追跡
- **決済機能（ポジション整理）**
  - 決済価格指定による手動決済
  - 決済時のトレール設定
  - 関連ポジション（反対売買）の連動決済設定
  - 取引履歴の継続的な構築
- **トレール機能**
  - トレール幅、開始条件の設定
  - リアルタイムでのトレール状態監視
  - エントリー/決済両方でのトレール適用
- **両建て管理**
  - 両建てタイミングの自動判定
  - 分散エントリー（例：0.5lot × 2ポジション）
  - クロスアカウント両建て対応
  - ポジション整理時の両建て維持

#### 2.1.4 リスク管理
- **ロスカット監視**
  - EA経由でのリアルタイムロスカット検知
  - ポジションごとのネクストアクション設定
- **アクションチェーン**
  - ロスカット時の自動ポジション再構築
  - 利益確定ポジションの自動決済
  - アカウント間でのバランス調整

### 2.2 管理機能

#### 2.2.1 ダッシュボード
- **Admin側 (メイン管理画面)**:
  - 接続中のクライアントPC一覧表示
  - 各口座のリアルタイム状態表示
    - 残高、有効証拠金、ボーナス額
    - オープンポジション一覧
    - 損益状況
  - システム全体の統計情報
- **Hedge System側 (簡素な監視)**:
  - ローカル接続状態確認
  - 緊急時の最小限表示のみ

#### 2.2.2 取引操作
- 個別/一括エントリー指示
- 決済指示（個別/条件付き一括）
- トレール設定の変更

#### 2.2.3 システムアップデート管理（MVP最小限）
- 手動アップデートのみ（取引システムの安全性重視）
- クライアントPC側での手動実行
- 最もシンプルな実装（Tauri標準機能活用）


## 3. 非機能要件

### 3.1 パフォーマンス
- **同時接続数**: 10-50台のクライアントPC
- **レスポンス時間**: 
  - EA→システム：100ms以内
  - システム→EA：200ms以内
  - 管理画面操作：1秒以内
- **データ更新頻度**: リアルタイム（1秒以内）

### 3.2 可用性
- **稼働率目標**: 99.5%以上
- **自動復旧**: 
  - WebSocket自動再接続
  - EA接続断時の自動リトライ
- **障害通知**: システム異常時の即時アラート

### 3.3 セキュリティ（MVP最小限）
- **認証**: AWS Cognito基本認証のみ
- **通信**: HTTPS/WSS暗号化
- **データ保存**: ローカルファイルベース（暗号化なし）

### 3.4 運用性（MVP最小限）
- **アップデート管理**: 
  - Hedge System: 手動アップデートのみ（取引安全性重視）
  - クライアント側からの手動実行（最も簡単な実装）
  - EA更新: 手動更新のみ

## 4. データモデル

### 4.1 主要エンティティ
```typescript
// ユーザー
interface User {
  id: string
  email: string
  role: 'admin' | 'client'
  clientPCs: ClientPC[]
}

// クライアントPC
interface ClientPC {
  id: string
  userId: string
  name: string
  status: 'online' | 'offline'
  accounts: Account[]
}

// 取引口座
interface Account {
  id: string
  clientPCId: string
  broker: string
  accountNumber: string
  balance: number
  bonusAmount: number
  positions: Position[]
}

// ポジション
interface Position {
  id: string
  accountId: string
  symbol: string
  type: 'buy' | 'sell'
  lots: number
  openPrice: number
  currentPrice: number
  profit: number
  trailSettings: TrailSettings
  nextAction: NextAction
  relatedPositionId?: string // 両建て関連ポジション
  closeSettings?: CloseSettings // 決済設定
}

// 決済設定
interface CloseSettings {
  targetPrice: number
  trailSettings?: TrailSettings
  linkedCloseAction?: {
    positionId: string
    action: 'close' | 'trail'
    settings?: TrailSettings
  }
}
```

## 5. 開発フェーズ

### Phase 1: MVP (現在)
- [x] 基本的なシステム構成
- [x] ユーザー認証（Cognito）
- [x] 手動アップデート（Tauri）
- [ ] EA-WebSocket連携
- [ ] 基本的な手動エントリー機能
- [ ] 基本的な決済機能
- [ ] リアルタイムポジション監視
- [ ] 管理画面での基本操作

### Phase 2: 自動化機能
- [ ] トレール自動実行
- [ ] 両建て自動実行
- [ ] ロスカット時の自動アクション
- [ ] アラート通知システム

### Phase 3: 高度な機能
- [ ] エントリーロジックの組み込み
- [ ] AI/MLによる最適化
- [ ] 詳細な分析レポート
- [ ] マルチストラテジー対応

## 6. 技術スタック

### 6.1 確定済み
- **Frontend**: Next.js 15.3.2, React 19, Tailwind CSS v4
- **Desktop**: Tauri v2
- **Backend**: AWS Amplify Gen2, AppSync (GraphQL), DynamoDB
- **認証**: AWS Cognito
- **通信**: WebSocket

### 6.2 EA開発
- **言語**: MQL5
- **通信**: WebSocketクライアントライブラリ（DLL経由）
- **データ形式**: JSON

## 7. 制約事項

### 7.1 技術的制約
- MT4/MT5の仕様に依存
- WebRequestの制限（MT5の場合）
- Windowsプラットフォーム限定（MT4/MT5のため）

### 7.2 ビジネス制約
- 各FX業者の利用規約遵守
- ボーナス悪用と判定されない実装
- 複数口座間の関連性を隠蔽
- 基本的な取引記録のみ保持

## 8. リスクと対策

### 8.1 技術リスク
| リスク | 影響度 | 対策 |
|--------|--------|------|
| EA接続断 | 高 | 自動再接続、状態監視強化 |
| レート遅延 | 中 | 複数ソースからのレート取得 |
| システム障害 | 高 | 冗長化、自動フェイルオーバー |

### 8.2 ビジネスリスク
| リスク | 影響度 | 対策 |
|--------|--------|------|
| 出金拒否 | 高 | 取引パターンのランダム化 |
| 口座凍結 | 高 | 分散取引、自然な取引パターン |
| 規約変更 | 中 | 定期的な規約確認、柔軟な設定 |

## 9. 用語定義

- **ボーナスアービトラージ**: FX業者が提供するボーナスを活用し、リスクを最小化しながら利益を得る取引手法
- **両建て**: 同一通貨ペアで買いと売りの両方のポジションを保有すること
- **トレール**: 利益方向に価格が動いた際に、損切り位置を自動的に調整する機能
- **EA (Expert Advisor)**: MT4/MT5上で動作する自動売買プログラム
- **ロスカット**: 証拠金維持率が一定以下になった際の強制決済