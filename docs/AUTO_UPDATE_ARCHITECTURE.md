# 自動アップデートアーキテクチャ

## 概要

Hedge SystemはTauri v2のアップデーター機能を使用して、以下の2つのアップデート方式を提供しています：

1. **ポップアップ通知型アップデート**（デフォルト）
   - 新しいバージョンが利用可能時にポップアップで通知
   - ユーザーが「今すぐ更新」または「後で更新」を選択可能

2. **メニューからの手動アップデート**
   - macOS/Windowsのネイティブメニューから「アップデートを確認」を選択
   - ユーザーが任意のタイミングでアップデートをチェック可能

## アップデートフロー

### 1. アップデートチェックのタイミング

- **起動時**: アプリ起動の10秒後に初回チェック
- **定期的**: 30分ごとに新しいバージョンをチェック
- **手動**: メニューから「アップデートを確認」を選択時
- **バックグラウンド**: ユーザーの作業を妨げずに実行

### 2. アップデート通知プロセス

1. **バージョンチェック**
   - S3上の`latest.json`を確認
   - 現在のバージョンと比較

2. **ポップアップ通知**
   - 新しいバージョンが利用可能時にダイアログ表示
   - 現在のバージョンと新しいバージョンを表示
   - 更新内容（リリースノート）を表示

3. **ユーザー選択**
   - 「今すぐ更新」: 即座にダウンロード・インストール開始
   - 「後で更新」: 通知を閉じて後でアップデート

4. **ダウンロード・インストール**
   - バックグラウンドでダウンロード
   - 進捗はコンソールログに記録
   - インストール完了後、3秒後に自動再起動

### 3. メニューからの手動アップデート

1. **メニュー選択**
   - macOS: アプリケーションメニュー → Hedge System → アップデートを確認
   - Windows: メニューバー → Hedge System → アップデートを確認

2. **即座にチェック**
   - バックグラウンドチェックを待たずに即座に実行
   - 最新版の場合は「最新です」メッセージを表示

## 実装詳細

### フロントエンド実装

#### `hooks/useAutoUpdater.ts`
```typescript
// 自動アップデートフック
useAutoUpdater({
  silent: true,              // サイレントモード
  checkInterval: 15 * 60 * 1000,  // 15分ごと
  initialDelay: 5 * 1000,    // 起動5秒後
});
```

主な機能：
- アップデートの自動チェック
- バックグラウンドダウンロード
- 進捗の追跡
- 自動再起動の実行

#### `components/providers.tsx`
アプリ全体に自動アップデート機能を提供：
```typescript
<AutoUpdaterWrapper>
  {children}
</AutoUpdaterWrapper>
```

### バックエンド実装

#### Rustプラグイン
- `tauri-plugin-updater`: アップデート機能
- `tauri-plugin-process`: プロセス再起動機能

#### 設定ファイル
`tauri.conf.json`:
```json
{
  "plugins": {
    "updater": {
      "endpoints": [
        "https://amplify-arbitrageassistantreleases.s3.ap-northeast-1.amazonaws.com/releases/hedge-system/latest.json"
      ],
      "pubkey": "..."
    }
  }
}
```

## セキュリティ

### 署名検証
- すべてのアップデートファイルは署名付き
- 公開鍵による自動検証
- 改ざんされたファイルは拒否

### HTTPS通信
- すべての通信はHTTPS経由
- 中間者攻撃を防止

## ユーザー体験

### 完全自動化のメリット
1. **ゼロクリック**: ユーザー操作不要
2. **常に最新**: セキュリティパッチが自動適用
3. **中断なし**: バックグラウンドで処理

### 透明性
- コンソールログで進捗を確認可能
- 開発者モードで詳細ログを表示

## カスタマイズオプション

### サイレントモードの無効化
```typescript
useAutoUpdater({
  silent: false,  // ユーザー確認を求める
});
```

### チェック間隔の変更
```typescript
useAutoUpdater({
  checkInterval: 60 * 60 * 1000,  // 1時間ごと
});
```

### 手動アップデートUIの追加
`UpdateChecker`コンポーネントを使用して、手動チェックボタンを追加可能。

## トラブルシューティング

### アップデートが実行されない場合

1. **ネットワーク接続**
   - S3エンドポイントへの接続を確認
   - プロキシ設定を確認

2. **署名エラー**
   - 公開鍵が正しいか確認
   - 署名ファイルが存在するか確認

3. **権限エラー**
   - アプリケーションフォルダへの書き込み権限
   - 管理者権限が必要な場合がある

### ログの確認方法

開発者ツールのコンソールで確認：
```
アップデートをチェック中...
新しいバージョン 0.1.18 が利用可能です
バックグラウンドでダウンロード開始...
ダウンロード進捗: 20%
ダウンロード進捗: 40%
...
アップデートのインストール完了。アプリを再起動します...
```

## 今後の改善案

1. **差分アップデート**
   - 変更部分のみダウンロード
   - ダウンロードサイズの削減

2. **スケジュール設定**
   - 営業時間外のみアップデート
   - ユーザー設定可能な時間帯

3. **ロールバック機能**
   - 問題発生時の自動ロールバック
   - 前バージョンの保持

4. **アップデート通知**
   - オプションで通知を表示
   - 更新内容の表示

## 注意事項

### macOS特有の制限
- 未署名アプリの場合、自動アップデート後も検疫属性の問題が発生する可能性
- Apple Developer証明書での署名が推奨

### Windows特有の制限
- UAC（ユーザーアカウント制御）により、管理者権限が必要な場合がある
- Windows Defenderによるスキャンで遅延が発生する可能性

### 開発環境での動作
- 開発モードでは自動アップデートは無効
- プロダクションビルドでのみ動作