#!/bin/bash

# ðŸ”„ ã‚¦ã‚©ãƒ¼ã‚¿ãƒ¼ãƒ•ã‚©ãƒ¼ãƒ«æ¬¡ã‚µã‚¤ã‚¯ãƒ«æº–å‚™ã‚·ã‚¹ãƒ†ãƒ 

set -e

TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')
CYCLE_ID="cycle-$(date '+%Y%m%d_%H%M%S')"
CYCLE_DIR="tasks/cycles/cycle-history/$CYCLE_ID"

echo "ðŸ”„ ã‚¦ã‚©ãƒ¼ã‚¿ãƒ¼ãƒ•ã‚©ãƒ¼ãƒ«æ¬¡ã‚µã‚¤ã‚¯ãƒ«æº–å‚™é–‹å§‹"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# Phase 1: ç¾ã‚µã‚¤ã‚¯ãƒ«è¨˜éŒ²ä¿å­˜
echo ""
echo "ðŸ“ Phase 1: ç¾ã‚µã‚¤ã‚¯ãƒ«è¨˜éŒ²ä¿å­˜"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"

mkdir -p "$CYCLE_DIR"/{tasks,reports,status,quality}

echo "ðŸ” ç¾ã‚µã‚¤ã‚¯ãƒ«è¨˜éŒ²ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ä¸­..."

# ã‚¿ã‚¹ã‚¯è¨˜éŒ²ä¿å­˜
if [ -d "tasks/directors" ]; then
    cp -r "tasks/directors" "$CYCLE_DIR/tasks/"
    task_count=$(find "tasks/directors" -name "*.md" | wc -l | tr -d ' ')
    echo "  âœ… ã‚¿ã‚¹ã‚¯è¨˜éŒ²: ${task_count}ä»¶ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–"
fi

# å ±å‘Šè¨˜éŒ²ä¿å­˜
if [ -d "tasks/reports" ]; then
    cp -r "tasks/reports" "$CYCLE_DIR/"
    report_count=$(find "tasks/reports" -name "*.md" | wc -l | tr -d ' ')
    echo "  âœ… å ±å‘Šè¨˜éŒ²: ${report_count}ä»¶ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–"
fi

# çŠ¶æ³è¨˜éŒ²ä¿å­˜
if [ -d "tasks/status" ]; then
    cp -r "tasks/status" "$CYCLE_DIR/"
    echo "  âœ… çŠ¶æ³è¨˜éŒ²: ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–å®Œäº†"
fi

# Phase 2: å“è³ªåˆ†æžãƒ»æ”¹å–„è¨ˆç”»ä½œæˆ
echo ""
echo "ðŸ“Š Phase 2: å“è³ªåˆ†æžãƒ»æ”¹å–„è¨ˆç”»ä½œæˆ"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"

IMPROVEMENT_PLAN="tasks/cycles/incremental-plans/improvement-${CYCLE_ID}.md"

# æœ€æ–°å®Œäº†åˆ¤å®šè¨˜éŒ²ã‚’å–å¾—
LATEST_COMPLETION=$(find "tasks/cycles/completion-records" -name "*.md" | sort | tail -1)

echo "ðŸ” å“è³ªåˆ†æžå®Ÿè¡Œä¸­..."

# æ”¹å–„è¨ˆç”»ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
cat > "$IMPROVEMENT_PLAN" << EOF
# å“è³ªæ”¹å–„è¨ˆç”»: $CYCLE_ID

## ðŸ“‹ è¨ˆç”»æƒ…å ±
- **ä½œæˆæ—¥æ™‚**: $TIMESTAMP
- **å‰ã‚µã‚¤ã‚¯ãƒ«**: $CYCLE_ID
- **è¨ˆç”»ç¨®åˆ¥**: å¢—åˆ†æ”¹å–„è¨ˆç”»

## ðŸ“Š å‰ã‚µã‚¤ã‚¯ãƒ«åˆ†æžçµæžœ

### å®Œäº†çŠ¶æ³åˆ†æž
$(if [ -f "$LATEST_COMPLETION" ]; then
    echo "å‰ã‚µã‚¤ã‚¯ãƒ«å®Œäº†åˆ¤å®šçµæžœ:"
    grep -A 10 "ç·åˆåˆ¤å®šçµæžœ" "$LATEST_COMPLETION" 2>/dev/null || echo "- å®Œäº†åˆ¤å®šè¨˜éŒ²ã‚’å‚ç…§"
else
    echo "- å®Œäº†åˆ¤å®šè¨˜éŒ²ãªã—"
fi)

### å“è³ªåˆ†æžçµæžœ
EOF

# å“è³ªãƒã‚§ãƒƒã‚¯å®Ÿè¡Œãƒ»çµæžœè¨˜éŒ²
echo "ðŸ” å“è³ªãƒã‚§ãƒƒã‚¯å®Ÿè¡Œä¸­..."
if npm run lint > "$CYCLE_DIR/quality/lint-result.log" 2>&1; then
    lint_result="âœ… åˆæ ¼"
else
    lint_result="âŒ æ”¹å–„å¿…è¦"
fi

if npm run check-types > "$CYCLE_DIR/quality/types-result.log" 2>&1; then
    types_result="âœ… åˆæ ¼"  
else
    types_result="âŒ æ”¹å–„å¿…è¦"
fi

# æ”¹å–„è¨ˆç”»ã«è¿½è¨˜
cat >> "$IMPROVEMENT_PLAN" << EOF
- **Lintå“è³ª**: $lint_result
- **åž‹å®‰å…¨æ€§**: $types_result
- **MVPæº–æ‹ **: $([ -f "MVPã‚·ã‚¹ãƒ†ãƒ è¨­è¨ˆ.md" ] && echo "âœ… ç¢ºèªæ¸ˆã¿" || echo "âš ï¸ è¦ç¢ºèª")

## ðŸŽ¯ æ¬¡ã‚µã‚¤ã‚¯ãƒ«æ”¹å–„è¨ˆç”»

### å„ªå…ˆæ”¹å–„é …ç›®
$(if [ "$lint_result" = "âŒ æ”¹å–„å¿…è¦" ]; then
    echo "1. **Lintå“è³ªå‘ä¸Š**: è­¦å‘Šãƒ»ã‚¨ãƒ©ãƒ¼ã®ä¿®æ­£ï¼ˆé«˜å„ªå…ˆåº¦ï¼‰"
fi
if [ "$types_result" = "âŒ æ”¹å–„å¿…è¦" ]; then
    echo "2. **åž‹å®‰å…¨æ€§å‘ä¸Š**: TypeScript ã‚¨ãƒ©ãƒ¼ã®ä¿®æ­£ï¼ˆé«˜å„ªå…ˆåº¦ï¼‰"
fi)
3. **æ©Ÿèƒ½æ‹¡å¼µ**: MVPæ©Ÿèƒ½ã®è¿½åŠ å®Ÿè£…
4. **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹**: å®Ÿè¡ŒåŠ¹çŽ‡ã®æœ€é©åŒ–
5. **å“è³ªå‘ä¸Š**: ãƒ†ã‚¹ãƒˆãƒ»æ¤œè¨¼ã®å¼·åŒ–

### å®Ÿè£…æŽ¨å¥¨é †åº
1. **å“è³ªä¿®æ­£**: Lintãƒ»åž‹ã‚¨ãƒ©ãƒ¼ã®å®Œå…¨ä¿®æ­£
2. **MVPå®Œæˆ**: è¨­è¨ˆæ›¸æº–æ‹ ã®å®Œå…¨å®Ÿè£…
3. **æ©Ÿèƒ½æ¤œè¨¼**: å‹•ä½œç¢ºèªãƒ»å“è³ªä¿è¨¼
4. **æœ€é©åŒ–**: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ãƒ»ä¿å®ˆæ€§å‘ä¸Š

### æ³¨æ„äº‹é …
- **MVPæº–æ‹ çµ¶å¯¾**: è¨­è¨ˆæ›¸å¤–ã®å®Ÿè£…ã¯ç¦æ­¢
- **Over-Engineeringé˜²æ­¢**: å¿…è¦æœ€å°é™ã®å®Ÿè£…
- **å“è³ªé‡è¦–**: å¦¥å”ãªã—ã®å“è³ªåŸºæº–ç¶­æŒ

## ðŸ“… æ¬¡ã‚µã‚¤ã‚¯ãƒ«å®Ÿè¡Œæº–å‚™

### æŽ¨å¥¨å®Ÿè¡Œæ‰‹é †
1. **åˆæœŸåŒ–å®Ÿè¡Œ**: \`npm run haconiwa:start\`
2. **å“è³ªç¢ºèª**: å‰ã‚µã‚¤ã‚¯ãƒ«æ”¹å–„é …ç›®ã®äº‹å‰ç¢ºèª
3. **CEOå®Ÿè¡Œ**: æˆ¦ç•¥åˆ¤æ–­ãƒ»DirectoræŒ‡ç¤ºé€ä¿¡
4. **ç¶™ç¶šç›£è¦–**: å“è³ªãƒ»é€²æ—ã®ç¶™ç¶šç›£è¦–

### æˆåŠŸæŒ‡æ¨™
- [ ] å…¨å“è³ªãƒã‚§ãƒƒã‚¯åˆæ ¼
- [ ] MVPæ©Ÿèƒ½å®Œå…¨å®Ÿè£…
- [ ] å…¨Directorãƒ»Specialistä½œæ¥­å®Œäº†
- [ ] ã‚¦ã‚©ãƒ¼ã‚¿ãƒ¼ãƒ•ã‚©ãƒ¼ãƒ«å®Ÿè¡Œå®Œäº†

## ðŸ”„ ç¶™ç¶šæ”¹å–„ãƒã‚¤ãƒ³ãƒˆ
- **å“è³ªåŸºæº–**: å¦¥å”ãªã—ã®é«˜å“è³ªç¶­æŒ
- **åŠ¹çŽ‡å‘ä¸Š**: å®Ÿè¡Œãƒ—ãƒ­ã‚»ã‚¹ã®æœ€é©åŒ–
- **å®Œæˆåº¦**: MVPè¦ä»¶ã®100%é”æˆ
- **ä¿å®ˆæ€§**: é•·æœŸç¶­æŒå¯èƒ½ãªå®Ÿè£…å“è³ª
EOF

echo "âœ… æ”¹å–„è¨ˆç”»ä½œæˆå®Œäº†: $IMPROVEMENT_PLAN"

# Phase 3: æ¬¡ã‚µã‚¤ã‚¯ãƒ«ç’°å¢ƒæº–å‚™
echo ""
echo "ðŸš€ Phase 3: æ¬¡ã‚µã‚¤ã‚¯ãƒ«ç’°å¢ƒæº–å‚™"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"

echo "ðŸ”„ æ¬¡ã‚µã‚¤ã‚¯ãƒ«ç’°å¢ƒã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ä¸­..."

# å®Œäº†æ¸ˆã¿ã‚¿ã‚¹ã‚¯ç§»å‹•
if [ -d "tasks/directors" ]; then
    mkdir -p "tasks/completed"
    find "tasks/directors" -name "*.md" -exec mv {} "tasks/completed/" \;
    echo "  âœ… å®Œäº†ã‚¿ã‚¹ã‚¯ç§»å‹•å®Œäº†"
fi

# å ±å‘Šè¨˜éŒ²ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ï¼ˆã‚¢ãƒ¼ã‚«ã‚¤ãƒ–æ¸ˆã¿ï¼‰
if [ -d "tasks/reports/specialist-reports" ]; then
    find "tasks/reports/specialist-reports" -name "*.md" -delete 2>/dev/null || true
    echo "  âœ… Specialistå ±å‘Šã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—"
fi

if [ -d "tasks/reports/director-reports" ]; then
    find "tasks/reports/director-reports" -name "*.md" -delete 2>/dev/null || true
    echo "  âœ… Directorå ±å‘Šã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—"
fi

# æœªç¢ºèªãƒªã‚¹ãƒˆã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
if [ -d "tasks/status/pending-actions" ]; then
    find "tasks/status/pending-actions" -name "*.list" -delete 2>/dev/null || true
    echo "  âœ… æœªç¢ºèªãƒªã‚¹ãƒˆã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—"
fi

# Phase 4: ã‚µã‚¤ã‚¯ãƒ«è¨˜éŒ²å®Œæˆ
echo ""
echo "ðŸ“‹ Phase 4: ã‚µã‚¤ã‚¯ãƒ«è¨˜éŒ²å®Œæˆ"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"

CYCLE_SUMMARY="$CYCLE_DIR/cycle-summary.md"

cat > "$CYCLE_SUMMARY" << EOF
# ã‚¦ã‚©ãƒ¼ã‚¿ãƒ¼ãƒ•ã‚©ãƒ¼ãƒ«å®Ÿè¡Œã‚µã‚¤ã‚¯ãƒ«è¨˜éŒ²: $CYCLE_ID

## ðŸ“‹ ã‚µã‚¤ã‚¯ãƒ«æƒ…å ±
- **ã‚µã‚¤ã‚¯ãƒ«ID**: $CYCLE_ID
- **å®Ÿè¡ŒæœŸé–“**: $TIMESTAMP ã¾ã§ã®ã‚µã‚¤ã‚¯ãƒ«
- **è¨˜éŒ²ä½œæˆ**: $TIMESTAMP

## ðŸ“Š å®Ÿè¡Œçµæžœã‚µãƒžãƒªãƒ¼
- **ã‚¿ã‚¹ã‚¯å®Ÿè¡Œ**: ${task_count:-0}ä»¶
- **å ±å‘Šå—ä¿¡**: ${report_count:-0}ä»¶
- **å“è³ªçŠ¶æ³**: Lint[$lint_result] Types[$types_result]

## ðŸ“ ä¿å­˜è¨˜éŒ²
- **ã‚¿ã‚¹ã‚¯è¨˜éŒ²**: $CYCLE_DIR/tasks/
- **å ±å‘Šè¨˜éŒ²**: $CYCLE_DIR/reports/
- **å“è³ªè¨˜éŒ²**: $CYCLE_DIR/quality/
- **æ”¹å–„è¨ˆç”»**: $IMPROVEMENT_PLAN

## ðŸ”„ æ¬¡ã‚µã‚¤ã‚¯ãƒ«æº–å‚™çŠ¶æ³
- âœ… è¨˜éŒ²ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–å®Œäº†
- âœ… æ”¹å–„è¨ˆç”»ä½œæˆå®Œäº†
- âœ… ç’°å¢ƒã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†
- âœ… æ¬¡ã‚µã‚¤ã‚¯ãƒ«å®Ÿè¡Œæº–å‚™å®Œäº†

## ðŸš€ æ¬¡ã‚µã‚¤ã‚¯ãƒ«æŽ¨å¥¨å®Ÿè¡Œ
\`\`\`bash
# æ¬¡ã‚µã‚¤ã‚¯ãƒ«é–‹å§‹ã‚³ãƒžãƒ³ãƒ‰
npm run haconiwa:start
\`\`\`

**æ¬¡ã‚µã‚¤ã‚¯ãƒ«ã§ã¯å“è³ªæ”¹å–„é …ç›®ã‚’é‡ç‚¹çš„ã«å®Ÿè£…ã—ã€MVPå®Œæˆåº¦ã®å‘ä¸Šã‚’å›³ã‚‹ã€‚**
EOF

echo "âœ… ã‚µã‚¤ã‚¯ãƒ«è¨˜éŒ²å®Œæˆ: $CYCLE_SUMMARY"

# å®Œäº†é€šçŸ¥
echo ""
echo "ðŸŽ‰ æ¬¡ã‚µã‚¤ã‚¯ãƒ«æº–å‚™å®Œäº†ï¼"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ðŸ“ ã‚µã‚¤ã‚¯ãƒ«è¨˜éŒ²: $CYCLE_DIR"
echo "ðŸ“‹ æ”¹å–„è¨ˆç”»: $IMPROVEMENT_PLAN"
echo "ðŸš€ æ¬¡ã‚µã‚¤ã‚¯ãƒ«å®Ÿè¡Œ: npm run haconiwa:start"

# ã‚¢ãƒ©ãƒ¼ãƒˆç”Ÿæˆ
echo "$(date '+%Y-%m-%d %H:%M:%S'),system,all,next-cycle-ready,success,$CYCLE_DIR" >> "tasks/alerts/important/next-cycle-ready.log"

