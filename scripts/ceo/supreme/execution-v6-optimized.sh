#!/bin/bash

# 🎯 CEO Supreme完璧実行スクリプト v6.1-Claude_Code対応版（品質最優先）
# CEO Supreme専用実行システム - Claude Code完全活用・深度分析・戦略判断・Director指示

echo "🎯 CEO Supreme v6.1-Claude_Code対応版 品質最優先実行開始"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""
echo "💎 品質最優先方針: 時間制限厳禁・Claude Code完全活用・妥協禁止"
echo "🎯 Claude Code実行品質・精度・完成度を最優先・深度分析必須"
echo "🔧 Claude Codeツール必須活用: Read・Glob・Grep・Edit・MultiEdit等"

# Phase 1: Claude Code完全活用診断（品質最優先・時間制限厳禁・深度分析）
echo ""
echo "📊 Phase 1: Claude Code完全活用診断開始"
echo "💎 品質最優先方針: 時間制限厳禁・Claude Code完全活用・妥協禁止"
echo "🎯 Claude Code深度分析・実装品質・完成度を最優先"
echo "🔧 必須Claude Codeツール: Read・Glob・Grep・Edit・MultiEdit等"
echo "────────────────────────────────────────────────"
echo ""

# Phase 1-1: Claude Code設計書完全読み込み（CEO必須深度理解）
echo "📚 Phase 1-1: Claude Code設計書完全読み込み・全体把握"
echo "🔧 Claude Code Read活用: MVPシステム設計.md完全読み込み実行中..."
echo ""
echo "【Claude Code必須指示】以下のClaude Codeツールを使用して完璧な分析を実行してください:"
echo ""
echo "1. Read MVPシステム設計.md"
echo "   - 設計書完全読み込み・詳細理解"
echo "   - Backend・Trading・Integration・Frontend要件完全把握"
echo "   - MVP絶対準拠・Over-Engineering防止要件確認"
echo ""
echo "2. Read arbitrage-assistant.yaml"
echo "   - Haconiwaエージェント構成完全把握"
echo "   - Director・Specialist役割分担確認"
echo "   - 技術スタック・専門領域完全理解"
echo ""
echo "⚠️ 重要: 上記Claude Codeツール使用なしでのCEO判断は品質不十分・妥協状態です"
echo "💎 品質最優先: 必ずClaude Code Readで完全読み込み・深度理解を実行してください"

echo ""
echo "📊 Phase 1-2: Claude Code実装状況完全分析（品質最優先・深度分析必須）"
echo "🔧 Claude Code Glob・Read活用: 実装ファイル構造完全把握実行中..."
echo ""
echo "【Claude Code必須指示】以下のClaude Codeツールで実装完成度を完全分析してください:"
echo ""
echo "3. Glob **/*.ts **/*.tsx"
echo "   - 全実装ファイル構造完全把握"
echo "   - Backend・Trading・Integration・Frontend実装状況確認"
echo "   - ファイル数・実装規模・完成度評価"
echo ""
echo "4. Read packages/shared-backend/amplify/data/resource.ts"
echo "   - Backend実装詳細完全読み込み・分析"
echo "   - User/Account/Position/Actionモデル実装確認"
echo "   - Over-Engineering検出・MVP準拠性確認"
echo ""
echo "5. LS apps/"
echo "   - アプリケーション構造完全確認"
echo "   - hedge-system・admin実装状況把握"
echo ""
echo "⚠️ 重要: 表面的なcat・grepでの確認は品質不十分・妥協状態です"
echo "💎 品質最優先: 必ずClaude Codeツールで完全読み込み・深度分析を実行してください"

echo ""
echo "📊 Phase 1-3: Claude Code Trading実装完全分析（品質最優先・深度分析必須）"
echo "🔧 Claude Code Read・Grep活用: Trading実装詳細完全分析実行中..."
echo ""
echo "【Claude Code必須指示】以下のClaude CodeツールでTrading実装を完全分析してください:"
echo ""
echo "6. Grep \"position\|arbitrage\|trading\|trail\" apps/hedge-system/"
echo "   - Trading関連実装ファイル完全検出"
echo "   - Position-Trail-Actionフロー実装状況確認"
echo "   - コアエンジン実装完成度評価"
echo ""
echo "7. Read apps/hedge-system/lib/ (Trading関連ファイル)"
echo "   - 検出されたTradingファイル詳細読み込み・分析"
echo "   - position-engine.ts・trail-engine.ts・action-engine.ts確認"
echo "   - 実装品質・MVP準拠性・Over-Engineering検出"
echo ""
echo "⚠️ 重要: findコマンドでの表面的確認は品質不十分・妥協状態です"
echo "💎 品質最優先: 必ずClaude Code Grep・Readで完全分析を実行してください"

echo ""
echo "📊 Phase 1-4: Claude Code Integration実装完全分析（品質最優先・深度分析必須）"
echo "🔧 Claude Code Glob・Read活用: Integration実装詳細完全分析実行中..."
echo ""
echo "【Claude Code必須指示】以下のClaude CodeツールでIntegration実装を完全分析してください:"
echo ""
echo "8. Glob ea/**/*.mq5"
echo "   - MT5 EA実装ファイル完全検出"
echo "   - MQL5実装状況・品質確認"
echo ""
echo "9. Grep \"websocket\|dll\" apps/hedge-system/"
echo "   - WebSocket実装ファイル検出"
echo "   - DLL連携実装確認"
echo ""
echo "10. Read (検出されたIntegrationファイル)"
echo "    - MT5・WebSocket・API連携実装詳細読み込み"
echo "    - レイテンシ最適化・実装品質確認"
echo ""
echo "⚠️ 重要: findコマンドでの表面的確認は品質不十分・妥協状態です"
echo "💎 品質最優先: 必ずClaude Code Glob・Grep・Readで完全分析を実行してください"

echo ""
echo "📊 Phase 1-5: Claude Code Frontend実装完全分析（品質最優先・深度分析必須）"
echo "🔧 Claude Code Glob・Read活用: Frontend実装詳細完全分析実行中..."
echo ""
echo "【Claude Code必須指示】以下のClaude CodeツールでFrontend実装を完全分析してください:"
echo ""
echo "11. Glob apps/admin/**/*.tsx"
echo "    - Admin管理画面実装ファイル完全検出"
echo "    - React/Next.jsページ・コンポーネント確認"
echo ""
echo "12. Read apps/hedge-system/src-tauri/tauri.conf.json"
echo "    - Tauri設定詳細読み込み・分析"
echo "    - デスクトップアプリ機能確認"
echo ""
echo "13. Grep \"context\|store\|state\" apps/"
echo "    - 状態管理実装検出・確認"
echo "    - React状態管理品質評価"
echo ""
echo "⚠️ 重要: findコマンドでの表面的確認は品質不十分・妥協状態です"
echo "💎 品質最優先: 必ずClaude Code Glob・Grep・Readで完全分析を実行してください"

echo ""
echo "✅ Phase 1完了: Claude Code完全活用診断・実装状況把握完了"
echo "💎 品質最優先・時間制限厳禁・Claude Code完全活用で実行してください"
echo "⚠️ 重要: 上記13個のClaude Codeツール実行なしでのPhase 2進行は品質不十分です"
echo "🔧 必須確認: Read・Glob・Grep等のClaude Codeツールを確実に実行してください"
echo ""
echo "【Phase 1 Claude Code必須実行チェックリスト】"
echo "□ 1. Read MVPシステム設計.md (設計書完全読み込み)"
echo "□ 2. Read arbitrage-assistant.yaml (エージェント構成理解)"
echo "□ 3. Glob **/*.ts **/*.tsx (実装ファイル構造把握)"
echo "□ 4. Read packages/shared-backend/amplify/data/resource.ts (Backend詳細)"
echo "□ 5. LS apps/ (アプリ構造確認)"
echo "□ 6. Grep \"position\|arbitrage\|trading\|trail\" apps/hedge-system/ (Trading検出)"
echo "□ 7. Read apps/hedge-system/lib/ (Trading詳細読み込み)"
echo "□ 8. Glob ea/**/*.mq5 (MT5 EA検出)"
echo "□ 9. Grep \"websocket\|dll\" apps/hedge-system/ (WebSocket検出)"
echo "□ 10. Read (検出されたIntegrationファイル)"
echo "□ 11. Glob apps/admin/**/*.tsx (Admin画面検出)"
echo "□ 12. Read apps/hedge-system/src-tauri/tauri.conf.json (Tauri設定)"
echo "□ 13. Grep \"context\|store\|state\" apps/ (状態管理検出)"
echo ""
echo "⛔ 警告: Claude Codeツール未実行でのPhase 2進行は品質方針違反・妥協状態です"

# Phase 2: Claude Code深度分析に基づく戦略判断（品質最優先・時間制限厳禁）
echo ""
echo "🧠 Phase 2: Claude Code深度分析結果に基づく戦略判断開始"
echo "💎 品質最優先方針: Claude Code完全分析結果ベース・時間制限厳禁・完璧性重視"
echo "🎯 実装品質重視・MVP絶対準拠・Over-Engineering完全防止"
echo "🔧 前提条件: Phase 1のClaude Code 13項目ツール実行完了必須"
echo "────────────────────────────────────────────────"
echo ""

# Phase 2-1: Claude Code分析結果統合（CEO戦略基盤構築）
echo "🧠 Phase 2-1: Claude Code分析結果統合・戦略基盤構築"
echo "🔧 Phase 1 Claude Code分析結果を統合・評価します"
echo "⚠️ 注意: Claude Code未実行の場合、品質不十分な戦略判断となります"
echo ""

DIRECTOR_INSTRUCTIONS=()
PROTECT_COUNT=0
TASK_COUNT=0
STRATEGIC_PRIORITIES=()

echo "📊 Claude Code分析結果確認・統合中..."
echo "✅ Read MVP設計書: Claude Code完全読み込み結果を戦略基盤として使用"
echo "✅ Glob実装ファイル: Claude Code構造把握結果を評価基準として使用"
echo "✅ Read詳細実装: Claude Code深度分析結果を判断材料として使用"
echo "📋 Phase 1実行完了前提で戦略判断を継続します"

echo "📚 Phase 1 Claude Code分析結果を戦略判断基盤として活用中..."
echo "🔧 Claude Code Read MVP設計書結果: 完全要件理解済み（Phase 1実行前提）"
echo "🔧 Claude Code Read arbitrage-assistant.yaml結果: エージェント構成把握済み（Phase 1実行前提）"
echo "📊 MVP設計要件（Claude Code完全読み込み結果ベース）:"
echo "   • Backend: AWS Amplify Gen2 + GraphQL + userIdベース認証"
echo "   • Trading: Position-Trail-Action実行フロー + リスク管理"
echo "   • Integration: MT5 EA + WebSocket DLL + レイテンシ<10ms"
echo "   • Frontend: 管理画面 + Tauri v2デスクトップアプリ"
echo "   • MVP絶対準拠: Over-Engineering完全防止・禁止事項厳守"
echo "✅ Claude Code分析結果を戦略基盤として採用完了"

# Backend戦略判断（Claude Code完全分析結果ベース）
echo ""
echo "🗄️ Backend戦略判断（Claude Code完全分析結果ベース実行中...）"
echo "🔧 Claude Code Read resource.ts分析結果: 実装詳細完全把握済み（Phase 1実行前提）"
echo "🔧 Claude Code Grep Backend関連分析結果: 品質・MVP準拠性評価済み（Phase 1実行前提）"
echo ""

# Backend戦略判断（Claude Code分析結果活用）
BACKEND_STRATEGIC_DECISION=""
BACKEND_DETAILED_INSTRUCTION=""

echo "📊 Backend戦略判断（Claude Code分析結果統合）:"
echo "🔧 前提: Phase 1でRead resource.ts・Grep実装チェック・MVP準拠性確認完了"

if [ -f "packages/shared-backend/amplify/data/resource.ts" ]; then
    echo "📁 Backend実装ファイル存在確認: ✅"
    echo "🔍 Claude Code分析結果ベース判定実行中..."
    
    # 簡易確認（Claude Code詳細分析の補完として）
    BASIC_MODELS=$(grep -c "User\|Account\|Position\|Action" packages/shared-backend/amplify/data/resource.ts 2>/dev/null || echo "0")
    BASIC_UNNECESSARY=$(grep -c "Performance\|Analytics\|Metrics\|Dashboard\|Report" packages/shared-backend/amplify/data/resource.ts 2>/dev/null || echo "0")
    
    echo "📊 基本実装確認（Claude Code詳細分析の補完）:"
    echo "   必須モデル検出: $BASIC_MODELS/4 (User/Account/Position/Action)"
    echo "   不要実装検出: $BASIC_UNNECESSARY個 (Over-Engineering)"
    
    
    echo ""
    echo "🧠 Backend戦略判断（Claude Code完全分析結果 + 基本確認統合）:"
    # Claude Code分析結果を基準とした戦略判断
    CORE_MODELS_COUNT=$BASIC_MODELS
    
    if [ "$CORE_MODELS_COUNT" -ge 4 ] && [ "$BASIC_UNNECESSARY" -eq 0 ]; then
        echo "   ✅ 判定: MVP完全実装済み・保護対象（Claude Code詳細分析済み）"
        echo "   🛡️ 戦略: 既存実装完全保護・Over-Engineering防止継続"
        BACKEND_STRATEGIC_DECISION="実装保護"
        BACKEND_DETAILED_INSTRUCTION="【Claude Code品質重視指示】MVP完全実装確認済み（Phase 1 Read分析結果）。必ずClaude Code Read・Grep・Edit等で品質確認・保護実行。Over-Engineering検出・防止継続。"
        PROTECT_COUNT=$((PROTECT_COUNT + 1))
    elif [ "$CORE_MODELS_COUNT" -ge 3 ] && [ "$BASIC_UNNECESSARY" -gt 0 ]; then
        echo "   🧹 判定: Over-Engineering検出・クリーンアップ必要（Claude Code分析要）"
        echo "   ⚠️ 戦略: 不要実装完全削除・MVP絶対準拠復元"
        BACKEND_STRATEGIC_DECISION="クリーンアップ実行"
        BACKEND_DETAILED_INSTRUCTION="【Claude Code必須活用指示】必ずClaude Code Read・Grep・Edit活用で不要実装削除実行。Performance/Analytics/Metrics等Over-Engineering完全削除、MVP絶対準拠復元。forbidden-edits.md厳守。品質重視・時間制限なし。"
        STRATEGIC_PRIORITIES+=("Backend:Over-Engineering解消")
        TASK_COUNT=$((TASK_COUNT + 1))
    elif [ "$CORE_MODELS_COUNT" -ge 1 ]; then
        echo "   🔧 判定: 部分実装・MVP完成要（Claude Code深度実装要）"
        echo "   🎯 戦略: 不足モデル実装・AWS Amplify基盤完成"
        BACKEND_STRATEGIC_DECISION="MVP完成実行"
        BACKEND_DETAILED_INSTRUCTION="【Claude Code必須活用指示】必ずClaude Code Read・Glob・Grep・Edit・MultiEdit活用でMVP完成実行。不足モデル実装、GraphQL設計、userIdベース認証統合。MVP設計書準拠・品質重視・時間制限なし。"
        STRATEGIC_PRIORITIES+=("Backend:MVP完成")
        TASK_COUNT=$((TASK_COUNT + 1))
    else
        echo "   🚀 判定: 新規実装必要・基盤構築（Claude Code完全活用要）"
        echo "   🎯 戦略: AWS Amplify Gen2基盤新規構築"
        BACKEND_STRATEGIC_DECISION="新規基盤構築"
        BACKEND_DETAILED_INSTRUCTION="【Claude Code必須活用指示】必ずClaude Code Read・Glob・Write・Edit活用でAWS Amplify Gen2基盤完全構築。data/resource.ts設計、User/Account/Position/Actionモデル実装、GraphQL schema設計、認証設計。MVP設計書準拠・品質重視・時間制限なし。"
        STRATEGIC_PRIORITIES+=("Backend:新規構築")
        TASK_COUNT=$((TASK_COUNT + 1))
    fi
else
    echo "   ❌ 判定: 実装ファイル未存在・緊急構築要（Claude Code完全活用要）"
    BACKEND_STRATEGIC_DECISION="緊急調査・構築"
    BACKEND_DETAILED_INSTRUCTION="【Claude Code必須活用指示】packages/shared-backend/amplify/data/resource.ts未存在。必ずClaude Code LS・Glob・Read・Write活用で緊急調査・構築実行。MVP基盤要件分析、AWS Amplify Gen2実装可能性評価、基盤構築計画策定・実行。品質重視・時間制限なし。"
    STRATEGIC_PRIORITIES+=("Backend:緊急調査")
    TASK_COUNT=$((TASK_COUNT + 1))
fi

echo "🎯 Backend戦略決定: $BACKEND_STRATEGIC_DECISION"

# Trading深度戦略分析（実装内容詳細読み込み・動的判断）
echo ""
echo "⚡ Trading深度戦略分析（実装内容詳細読み込み中...）"

# Trading実装ファイル詳細読み込み・分析
TRADING_STRATEGIC_DECISION=""
TRADING_DETAILED_INSTRUCTION=""

echo "🔍 Trading実装ファイル詳細分析中..."
POSITION_ENGINE_EXISTS=0
TRAIL_ENGINE_EXISTS=0
ACTION_ENGINE_EXISTS=0
ARBITRAGE_ENGINE_EXISTS=0

# 主要エンジンファイルの存在・内容確認（実際のファイル構造に基づく）
if [ -f "apps/hedge-system/lib/position-execution.ts" ]; then
    POSITION_ENGINE_EXISTS=1
    POSITION_ENGINE_CONTENT=$(cat "apps/hedge-system/lib/position-execution.ts" 2>/dev/null | head -30)
    POSITION_FUNCTIONS=$(echo "$POSITION_ENGINE_CONTENT" | grep -E "function|export|class" | wc -l | xargs)
    echo "📊 Position Engine: 実装済み ($POSITION_FUNCTIONS個の関数/クラス)"
fi

if [ -f "apps/hedge-system/lib/trail-engine.ts" ]; then
    TRAIL_ENGINE_EXISTS=1
    TRAIL_ENGINE_CONTENT=$(cat "apps/hedge-system/lib/trail-engine.ts" 2>/dev/null | head -30)
    TRAIL_FUNCTIONS=$(echo "$TRAIL_ENGINE_CONTENT" | grep -E "function|export|class" | wc -l | xargs)
    echo "📊 Trail Engine: 実装済み ($TRAIL_FUNCTIONS個の関数/クラス)"
fi

if [ -f "apps/hedge-system/lib/action-manager.ts" ]; then
    ACTION_ENGINE_EXISTS=1
    ACTION_ENGINE_CONTENT=$(cat "apps/hedge-system/lib/action-manager.ts" 2>/dev/null | head -30)
    ACTION_FUNCTIONS=$(echo "$ACTION_ENGINE_CONTENT" | grep -E "function|export|class" | wc -l | xargs)
    echo "📊 Action Engine: 実装済み ($ACTION_FUNCTIONS個の関数/クラス)"
fi

if [ -f "apps/hedge-system/lib/hedge-manager.ts" ]; then
    ARBITRAGE_ENGINE_EXISTS=1
    ARBITRAGE_ENGINE_CONTENT=$(cat "apps/hedge-system/lib/hedge-manager.ts" 2>/dev/null | head -30)
    ARBITRAGE_FUNCTIONS=$(echo "$ARBITRAGE_ENGINE_CONTENT" | grep -E "function|export|class" | wc -l | xargs)
    echo "📊 Hedge Engine: 実装済み ($ARBITRAGE_FUNCTIONS個の関数/クラス)"
fi

# 詳細実装品質評価
CORE_ENGINES_COUNT=$((POSITION_ENGINE_EXISTS + TRAIL_ENGINE_EXISTS + ACTION_ENGINE_EXISTS + ARBITRAGE_ENGINE_EXISTS))
echo "📋 Trading実装状況:"
echo "   Position Engine: $POSITION_ENGINE_EXISTS  Trail Engine: $TRAIL_ENGINE_EXISTS"
echo "   Action Engine: $ACTION_ENGINE_EXISTS  Arbitrage Engine: $ARBITRAGE_ENGINE_EXISTS"
echo "   コアエンジン合計: $CORE_ENGINES_COUNT/4個"

# リスク管理・設定ファイル確認
RISK_MANAGEMENT_EXISTS=0
if [ -f "apps/hedge-system/src/lib/risk/manager.ts" ] || [ -f "apps/hedge-system/src/lib/config/trading.ts" ]; then
    RISK_MANAGEMENT_EXISTS=1
    echo "📊 リスク管理: 実装済み"
else
    echo "📊 リスク管理: 未実装"
fi

# 動的戦略判断・指示生成
if [ "$CORE_ENGINES_COUNT" -eq 4 ] && [ "$RISK_MANAGEMENT_EXISTS" -eq 1 ]; then
    echo "   ✅ 判定: Position-Trail-Actionフロー完全実装・保護対象"
    echo "   🛡️ 戦略: 既存実装完全保護・パフォーマンス最適化のみ"
    TRADING_STRATEGIC_DECISION="実装保護・最適化"
    TRADING_DETAILED_INSTRUCTION="MVP完全実装確認済み。Position-Trail-Actionフロー・リスク管理システム完備。品質保護継続、パフォーマンス最適化のみ実行。"
    PROTECT_COUNT=$((PROTECT_COUNT + 1))
elif [ "$CORE_ENGINES_COUNT" -ge 3 ]; then
    echo "   🔧 判定: 主要実装済み・完成要"
    echo "   🎯 戦略: 不足エンジン実装・フロー統合完成"
    TRADING_STRATEGIC_DECISION="フロー完成実行"
    
    # 不足エンジンの具体的特定
    MISSING_ENGINES=""
    [ "$POSITION_ENGINE_EXISTS" -eq 0 ] && MISSING_ENGINES="$MISSING_ENGINES position-engine.ts"
    [ "$TRAIL_ENGINE_EXISTS" -eq 0 ] && MISSING_ENGINES="$MISSING_ENGINES trail-engine.ts"
    [ "$ACTION_ENGINE_EXISTS" -eq 0 ] && MISSING_ENGINES="$MISSING_ENGINES action-engine.ts"
    [ "$ARBITRAGE_ENGINE_EXISTS" -eq 0 ] && MISSING_ENGINES="$MISSING_ENGINES arbitrage/engine.ts"
    
    TRADING_DETAILED_INSTRUCTION="現在の実装: Position($POSITION_ENGINE_EXISTS) Trail($TRAIL_ENGINE_EXISTS) Action($ACTION_ENGINE_EXISTS) Arbitrage($ARBITRAGE_ENGINE_EXISTS)。不足エンジン:$MISSING_ENGINES を実装完了。Position-Trail-Actionフロー統合、リスク管理システム統合、ドローダウン<5%達成。MVP必須機能のみ実装。"
    STRATEGIC_PRIORITIES+=("Trading:フロー完成")
    TASK_COUNT=$((TASK_COUNT + 1))
elif [ "$CORE_ENGINES_COUNT" -ge 1 ]; then
    echo "   🚀 判定: 部分実装・基盤構築中"
    echo "   🎯 戦略: コアエンジン実装・フロー構築"
    TRADING_STRATEGIC_DECISION="コアエンジン構築"
    TRADING_DETAILED_INSTRUCTION="現在の実装レベル: $CORE_ENGINES_COUNT/4エンジン。Position-Trail-Actionフロー新規構築: position-engine.ts・trail-engine.ts・action-engine.ts・arbitrage/engine.ts実装。リスク管理統合。MVPシステム設計.md準拠で実装。Over-Engineering禁止。"
    STRATEGIC_PRIORITIES+=("Trading:コアエンジン構築")
    TASK_COUNT=$((TASK_COUNT + 1))
else
    echo "   🚀 判定: 新規実装必要・フロー構築"
    echo "   🎯 戦略: Position-Trail-Actionフロー新規構築"
    TRADING_STRATEGIC_DECISION="新規フロー構築"
    TRADING_DETAILED_INSTRUCTION="Trading実装未検出。Position-Trail-Actionフロー完全新規構築: apps/hedge-system/src/lib/trading/にposition-engine.ts・trail-engine.ts・action-engine.ts、apps/hedge-system/src/lib/arbitrage/にengine.ts実装。リスク管理システム統合。MVP必須機能のみ・Over-Engineering禁止。"
    STRATEGIC_PRIORITIES+=("Trading:新規フロー構築")
    TASK_COUNT=$((TASK_COUNT + 1))
fi

echo "🎯 Trading戦略決定: $TRADING_STRATEGIC_DECISION"

# Integration深度戦略分析（実装内容詳細読み込み・動的判断）
echo ""
echo "🔌 Integration深度戦略分析（実装内容詳細読み込み中...）"

# Integration実装ファイル詳細読み込み・分析
INTEGRATION_STRATEGIC_DECISION=""
INTEGRATION_DETAILED_INSTRUCTION=""

echo "🔍 Integration実装ファイル詳細分析中..."
MT5_EA_COUNT=0
WEBSOCKET_DLL_EXISTS=0
API_CONNECTOR_EXISTS=0

# MT5 EA実装確認（現実的には後段実装）
if [ -d "ea/" ]; then
    MT5_EA_COUNT=$(find ea/ -name "*.mq5" 2>/dev/null | wc -l | xargs)
    if [ "$MT5_EA_COUNT" -gt 0 ]; then
        echo "📊 MT5 EA実装: $MT5_EA_COUNT個のMQL5ファイル検出"
        # 主要EAファイルの内容確認
        for ea_file in $(find ea/ -name "*.mq5" | head -3); do
            ea_functions=$(grep -E "void OnTick|void OnStart|void OnInit" "$ea_file" 2>/dev/null | wc -l | xargs)
            echo "   📄 $(basename "$ea_file"): $ea_functions個の主要関数"
        done
    fi
else
    echo "📊 MT5 EA実装: ea/ディレクトリ未検出（後段実装）"
fi

# WebSocket実装確認（実際のファイル構造に基づく）
WEBSOCKET_RS_EXISTS=0
WEBSOCKET_TS_EXISTS=0

if [ -f "apps/hedge-system/src-tauri/src/websocket.rs" ]; then
    WEBSOCKET_RS_EXISTS=1
    WEBSOCKET_RS_CONTENT=$(cat "apps/hedge-system/src-tauri/src/websocket.rs" 2>/dev/null | head -30)
    WEBSOCKET_RS_FUNCTIONS=$(echo "$WEBSOCKET_RS_CONTENT" | grep -E "fn|struct|impl" | wc -l | xargs)
    echo "📊 WebSocket Rust実装: 実装済み ($WEBSOCKET_RS_FUNCTIONS個の関数/構造体)"
fi

if [ -f "apps/hedge-system/lib/websocket-handler.ts" ] || [ -f "apps/hedge-system/lib/websocket-server.ts" ]; then
    WEBSOCKET_TS_EXISTS=1
    echo "📊 WebSocket TypeScript実装: 実装済み"
fi

WEBSOCKET_DLL_EXISTS=$((WEBSOCKET_RS_EXISTS + WEBSOCKET_TS_EXISTS))

# API連携実装確認（実際のファイル構造に基づく）
API_CONNECTOR_FILES=$(find apps/hedge-system/lib -name "*amplify*" -o -name "*realtime*" 2>/dev/null | wc -l | xargs)
if [ "$API_CONNECTOR_FILES" -gt 0 ]; then
    API_CONNECTOR_EXISTS=1
    echo "📊 API連携実装: $API_CONNECTOR_FILES個のAPIファイル検出"
else
    echo "📊 API連携実装: 未検出"
fi

# 詳細実装品質評価
INTEGRATION_COMPONENTS_COUNT=$((MT5_EA_COUNT + WEBSOCKET_DLL_EXISTS + API_CONNECTOR_EXISTS))
echo "📋 Integration実装状況:"
echo "   MT5 EA: $MT5_EA_COUNT個  WebSocket/DLL: $WEBSOCKET_DLL_EXISTS  API連携: $API_CONNECTOR_EXISTS"
echo "   統合コンポーネント合計: $INTEGRATION_COMPONENTS_COUNT個"

# 動的戦略判断・指示生成
if [ "$MT5_EA_COUNT" -ge 1 ] && [ "$WEBSOCKET_DLL_EXISTS" -eq 1 ] && [ "$API_CONNECTOR_EXISTS" -eq 1 ]; then
    echo "   ✅ 判定: MT5統合完全実装・保護対象"
    echo "   🛡️ 戦略: 既存実装完全保護・レイテンシ最適化のみ"
    INTEGRATION_STRATEGIC_DECISION="統合保護・最適化"
    INTEGRATION_DETAILED_INSTRUCTION="MVP完全統合確認済み。MT5 EA ($MT5_EA_COUNT個)・WebSocket DLL・API連携実装完備。品質保護継続、レイテンシ最適化のみ実行。"
    PROTECT_COUNT=$((PROTECT_COUNT + 1))
elif [ "$MT5_EA_COUNT" -ge 1 ] && [ "$WEBSOCKET_DLL_EXISTS" -eq 1 ]; then
    echo "   🔌 判定: EA・WebSocket実装済み・API連携要"
    echo "   🎯 戦略: API連携実装・統合テスト完成"
    INTEGRATION_STRATEGIC_DECISION="API連携完成"
    INTEGRATION_DETAILED_INSTRUCTION="現在の実装: MT5 EA ($MT5_EA_COUNT個)・WebSocket DLL実装済み。API連携コンポーネント実装完了: apps/hedge-system/src/lib/api/にconnector.ts・exchange-api.ts実装。取引所API統合、レイテンシ<10ms達成。MVP連携機能のみ実装。"
    STRATEGIC_PRIORITIES+=("Integration:API連携完成")
    TASK_COUNT=$((TASK_COUNT + 1))
elif [ "$MT5_EA_COUNT" -ge 1 ]; then
    echo "   🔧 判定: EA実装済み・WebSocket統合要"
    echo "   🎯 戦略: WebSocket DLL実装・MT5統合完成"
    INTEGRATION_STRATEGIC_DECISION="WebSocket統合完成"
    INTEGRATION_DETAILED_INSTRUCTION="現在の実装: MT5 EA ($MT5_EA_COUNT個)実装済み。WebSocket DLL実装完了: C++/Rustプロトコル実装、MT5-WebSocket統合、ea/websocket/にDLL実装。レイテンシ<10ms達成、取引所API連携準備。MVP通信機能のみ実装。"
    STRATEGIC_PRIORITIES+=("Integration:WebSocket統合完成")
    TASK_COUNT=$((TASK_COUNT + 1))
else
    echo "   🚀 判定: 新規統合実装必要"
    echo "   🎯 戦略: MT5 EA・WebSocket統合新規構築"
    INTEGRATION_STRATEGIC_DECISION="新規統合構築"
    INTEGRATION_DETAILED_INSTRUCTION="Integration実装未検出。MT5 EA・WebSocket統合完全新規構築: ea/にMQL5 EA開発、ea/websocket/にWebSocket DLL実装（C++/Rust）、apps/hedge-system/src/lib/api/にAPI連携実装。レイテンシ<10ms達成、MVP連携機能のみ・Over-Engineering禁止。"
    STRATEGIC_PRIORITIES+=("Integration:新規統合構築")
    TASK_COUNT=$((TASK_COUNT + 1))
fi

echo "🎯 Integration戦略決定: $INTEGRATION_STRATEGIC_DECISION"

# Frontend深度戦略分析（実装内容詳細読み込み・動的判断）
echo ""
echo "🎨 Frontend深度戦略分析（実装内容詳細読み込み中...）"

# Frontend実装ファイル詳細読み込み・分析
FRONTEND_STRATEGIC_DECISION=""
FRONTEND_DETAILED_INSTRUCTION=""

echo "🔍 Frontend実装ファイル詳細分析中..."
ADMIN_PAGES_COUNT=0
TAURI_CONFIG_EXISTS=0
REACT_COMPONENTS_COUNT=0
STATE_MANAGEMENT_EXISTS=0

# Admin管理画面実装確認
if [ -d "apps/admin/app" ]; then
    ADMIN_PAGES_COUNT=$(find apps/admin/app -name "page.tsx" 2>/dev/null | wc -l | xargs)
    if [ "$ADMIN_PAGES_COUNT" -gt 0 ]; then
        echo "📊 Admin管理画面: $ADMIN_PAGES_COUNT個のページ検出"
        # 主要ページの内容確認
        for page_file in $(find apps/admin/app -name "page.tsx" | head -3); do
            page_components=$(grep -E "export.*function|const.*=.*component" "$page_file" 2>/dev/null | wc -l | xargs)
            echo "   📄 $(dirname "$page_file" | sed 's|apps/admin/app/||'): $page_components個のコンポーネント"
        done
    fi
else
    echo "📊 Admin管理画面: apps/admin/app未検出"
fi

# Tauri設定・実装確認
if [ -f "apps/hedge-system/src-tauri/tauri.conf.json" ]; then
    TAURI_CONFIG_EXISTS=1
    echo "📊 Tauri設定: tauri.conf.json検出"
    # Tauri実装詳細確認
    TAURI_FEATURES=$(grep -E "features|allowlist" "apps/hedge-system/src-tauri/tauri.conf.json" 2>/dev/null | wc -l | xargs)
    echo "   📄 Tauri機能設定: $TAURI_FEATURES個の設定項目"
    
    # Rustバックエンド確認
    if [ -f "apps/hedge-system/src-tauri/src/main.rs" ]; then
        RUST_FUNCTIONS=$(grep -E "fn |#\[tauri::command\]" "apps/hedge-system/src-tauri/src/main.rs" 2>/dev/null | wc -l | xargs)
        echo "   📄 Rustバックエンド: $RUST_FUNCTIONS個の関数"
    fi
else
    echo "📊 Tauri設定: 未検出"
fi

# React/Next.jsコンポーネント確認（実際のファイル構造に基づく）
HEDGE_SYSTEM_COMPONENTS=$(find apps/hedge-system -name "*.tsx" -o -name "*.ts" 2>/dev/null | grep -v node_modules | grep -v out | wc -l | xargs)
ADMIN_COMPONENTS=$(find apps/admin -name "*.tsx" -o -name "*.ts" 2>/dev/null | grep -v node_modules | wc -l | xargs)
REACT_COMPONENTS_COUNT=$((HEDGE_SYSTEM_COMPONENTS + ADMIN_COMPONENTS))

if [ "$REACT_COMPONENTS_COUNT" -gt 0 ]; then
    echo "📊 React/Next.jsコンポーネント: $REACT_COMPONENTS_COUNT個 (hedge-system: $HEDGE_SYSTEM_COMPONENTS, admin: $ADMIN_COMPONENTS)"
else
    echo "📊 React/Next.jsコンポーネント: 未検出"
fi

# 状態管理実装確認（実際のファイル構造に基づく）
STATE_MANAGEMENT_FILES=$(find apps/hedge-system -name "*context*" -o -name "*store*" 2>/dev/null | wc -l | xargs)
ADMIN_STATE_FILES=$(find apps/admin -name "*hooks*" -o -name "*context*" 2>/dev/null | wc -l | xargs)
TOTAL_STATE_FILES=$((STATE_MANAGEMENT_FILES + ADMIN_STATE_FILES))

if [ "$TOTAL_STATE_FILES" -gt 0 ]; then
    STATE_MANAGEMENT_EXISTS=1
    echo "📊 状態管理: $TOTAL_STATE_FILES個の状態管理ファイル検出"
else
    STATE_MANAGEMENT_EXISTS=0
    echo "📊 状態管理: 未検出"
fi

# 詳細実装品質評価
FRONTEND_COMPONENTS_COUNT=$((ADMIN_PAGES_COUNT + TAURI_CONFIG_EXISTS + (REACT_COMPONENTS_COUNT / 5) + STATE_MANAGEMENT_EXISTS))
echo "📋 Frontend実装状況:"
echo "   Admin画面: $ADMIN_PAGES_COUNT個  Tauri: $TAURI_CONFIG_EXISTS  React: $REACT_COMPONENTS_COUNT個  状態管理: $STATE_MANAGEMENT_EXISTS"
echo "   Frontend品質スコア: $FRONTEND_COMPONENTS_COUNT"

# 動的戦略判断・指示生成
if [ "$ADMIN_PAGES_COUNT" -ge 3 ] && [ "$TAURI_CONFIG_EXISTS" -eq 1 ] && [ "$REACT_COMPONENTS_COUNT" -ge 10 ] && [ "$STATE_MANAGEMENT_EXISTS" -eq 1 ]; then
    echo "   ✅ 判定: Frontend完全実装・保護対象"
    echo "   🛡️ 戦略: 既存実装完全保護・パフォーマンス最適化のみ"
    FRONTEND_STRATEGIC_DECISION="実装保護・最適化"
    FRONTEND_DETAILED_INSTRUCTION="MVP完全UI実装確認済み。Admin管理画面 ($ADMIN_PAGES_COUNT個)・Tauriアプリ・React/Next.jsコンポーネント・状態管理実装完備。品質保護継続、FCP<1.5s最適化のみ実行。"
    PROTECT_COUNT=$((PROTECT_COUNT + 1))
elif [ "$ADMIN_PAGES_COUNT" -ge 2 ] && [ "$TAURI_CONFIG_EXISTS" -eq 1 ]; then
    echo "   🎨 判定: 基盤実装済み・完成要"
    echo "   🎯 戦略: UI完成・状態管理統合・パフォーマンス達成"
    FRONTEND_STRATEGIC_DECISION="UI完成実行"
    FRONTEND_DETAILED_INSTRUCTION="現在の実装: Admin画面 ($ADMIN_PAGES_COUNT個)・Tauri設定済み・React ($REACT_COMPONENTS_COUNT個)。不足UI実装完了: 追加管理画面ページ・状態管理統合・コンポーネント最適化。FCP<1.5s達成、MVP UI機能のみ実装。"
    STRATEGIC_PRIORITIES+=("Frontend:UI完成")
    TASK_COUNT=$((TASK_COUNT + 1))
elif [ "$ADMIN_PAGES_COUNT" -ge 1 ] || [ "$TAURI_CONFIG_EXISTS" -eq 1 ] || [ "$REACT_COMPONENTS_COUNT" -ge 5 ]; then
    echo "   🔧 判定: 部分実装・基盤拡張要"
    echo "   🎯 戦略: Admin画面・Tauriアプリ完成"
    FRONTEND_STRATEGIC_DECISION="基盤拡張完成"
    FRONTEND_DETAILED_INSTRUCTION="現在の実装レベル: Admin($ADMIN_PAGES_COUNT) Tauri($TAURI_CONFIG_EXISTS) React($REACT_COMPONENTS_COUNT)。Frontend完成実行: apps/admin/appに管理画面追加、apps/hedge-system/src-tauri/にTauri v2統合、状態管理設計。MVP管理機能のみ・Over-Engineering禁止。"
    STRATEGIC_PRIORITIES+=("Frontend:基盤拡張完成")
    TASK_COUNT=$((TASK_COUNT + 1))
else
    echo "   🚀 判定: 新規実装必要・UI構築"
    echo "   🎯 戦略: 管理画面・Tauriアプリ新規構築"
    FRONTEND_STRATEGIC_DECISION="新規UI構築"
    FRONTEND_DETAILED_INSTRUCTION="Frontend実装未検出。管理画面・Tauriアプリ完全新規構築: apps/admin/appにReact/Next.js管理画面、apps/hedge-system/src-tauri/にTauri v2統合、状態管理設計、UI/UX設計。MVP管理機能のみ・Over-Engineering禁止。"
    STRATEGIC_PRIORITIES+=("Frontend:新規UI構築")
    TASK_COUNT=$((TASK_COUNT + 1))
fi

echo "🎯 Frontend戦略決定: $FRONTEND_STRATEGIC_DECISION"

# Phase 2-2: CEO戦略的依存関係分析・並列/直列判断システム
echo ""
echo "🏛️ Phase 2-2: CEO戦略的依存関係分析・並列/直列判断システム"

MVP_COMPLETION=$(( (PROTECT_COUNT * 100) / 4 ))

# 優先度評価システム（MVP依存関係・重要度に基づく）
echo ""
echo "🎯 CEO戦略優先度評価システム実行中..."

# 各部門の戦略重要度スコア計算（MVP依存関係考慮）
BACKEND_PRIORITY_SCORE=0
TRADING_PRIORITY_SCORE=0
INTEGRATION_PRIORITY_SCORE=0
FRONTEND_PRIORITY_SCORE=0

# Backend優先度評価（MVP基盤として最重要）
if [ "$BACKEND_STRATEGIC_DECISION" != "実装保護" ]; then
    if [ "$BACKEND_STRATEGIC_DECISION" = "緊急調査・構築" ]; then
        BACKEND_PRIORITY_SCORE=100  # 最高優先度：基盤未存在
    elif [ "$BACKEND_STRATEGIC_DECISION" = "新規基盤構築" ]; then
        BACKEND_PRIORITY_SCORE=95   # 基盤構築：他部門の前提条件
    elif [ "$BACKEND_STRATEGIC_DECISION" = "MVP完成実行" ]; then
        BACKEND_PRIORITY_SCORE=90   # MVP完成：基盤として重要
    elif [ "$BACKEND_STRATEGIC_DECISION" = "クリーンアップ実行" ]; then
        BACKEND_PRIORITY_SCORE=85   # クリーンアップ：Over-Engineering解消
    fi
    echo "🗄️ Backend優先度: $BACKEND_PRIORITY_SCORE点 ($BACKEND_STRATEGIC_DECISION)"
fi

# Trading優先度評価（Backend基盤に依存）
if [ "$TRADING_STRATEGIC_DECISION" != "実装保護・最適化" ]; then
    if [ "$TRADING_STRATEGIC_DECISION" = "新規フロー構築" ]; then
        TRADING_PRIORITY_SCORE=80   # Backend完成後の主要機能
    elif [ "$TRADING_STRATEGIC_DECISION" = "コアエンジン構築" ]; then
        TRADING_PRIORITY_SCORE=75   # エンジン実装継続
    elif [ "$TRADING_STRATEGIC_DECISION" = "フロー完成実行" ]; then
        TRADING_PRIORITY_SCORE=70   # 最終統合段階
    fi
    echo "⚡ Trading優先度: $TRADING_PRIORITY_SCORE点 ($TRADING_STRATEGIC_DECISION)"
fi

# Integration優先度評価（MVP外部連携・後段優先）
if [ "$INTEGRATION_STRATEGIC_DECISION" != "統合保護・最適化" ]; then
    if [ "$INTEGRATION_STRATEGIC_DECISION" = "新規統合構築" ]; then
        INTEGRATION_PRIORITY_SCORE=60   # 外部連携：後段実装
    elif [ "$INTEGRATION_STRATEGIC_DECISION" = "WebSocket統合完成" ]; then
        INTEGRATION_PRIORITY_SCORE=55   # WebSocket完成
    elif [ "$INTEGRATION_STRATEGIC_DECISION" = "API連携完成" ]; then
        INTEGRATION_PRIORITY_SCORE=50   # API統合
    fi
    echo "🔌 Integration優先度: $INTEGRATION_PRIORITY_SCORE点 ($INTEGRATION_STRATEGIC_DECISION)"
fi

# Frontend優先度評価（UI・最終段階優先）
if [ "$FRONTEND_STRATEGIC_DECISION" != "実装保護・最適化" ]; then
    if [ "$FRONTEND_STRATEGIC_DECISION" = "新規UI構築" ]; then
        FRONTEND_PRIORITY_SCORE=40   # UI：最終段階実装
    elif [ "$FRONTEND_STRATEGIC_DECISION" = "基盤拡張完成" ]; then
        FRONTEND_PRIORITY_SCORE=35   # UI基盤拡張
    elif [ "$FRONTEND_STRATEGIC_DECISION" = "UI完成実行" ]; then
        FRONTEND_PRIORITY_SCORE=30   # UI最終仕上げ
    fi
    echo "🎨 Frontend優先度: $FRONTEND_PRIORITY_SCORE点 ($FRONTEND_STRATEGIC_DECISION)"
fi

# 🔗 CEO戦略的依存関係分析システム（v6.0新機能）
echo ""
echo "🔗 CEO戦略的依存関係分析システム実行中..."

# 依存関係マッピング
BACKEND_DEPENDS_ON=""    # Backend：他に依存しない（基盤）
TRADING_DEPENDS_ON=""    # Trading：通常Backend基盤が必要
INTEGRATION_DEPENDS_ON="" # Integration：通常Trading実装が参考として必要
FRONTEND_DEPENDS_ON=""   # Frontend：Backend APIが参考として必要

# Backend基盤の状況により依存関係動的判定
if [ "$BACKEND_STRATEGIC_DECISION" = "実装保護" ]; then
    # Backend完成済み→他部門のBackend依存解消
    TRADING_DEPENDS_ON=""      # Trading：Backend完成済みで依存なし
    FRONTEND_DEPENDS_ON=""     # Frontend：Backend完成済みで依存なし
    echo "✅ Backend基盤完成済み → Trading/Frontend のBackend依存関係解消"
elif [ "$BACKEND_STRATEGIC_DECISION" = "MVP完成実行" ] || [ "$BACKEND_STRATEGIC_DECISION" = "クリーンアップ実行" ]; then
    # Backend部分実装→軽度の依存関係（並列可能）
    TRADING_DEPENDS_ON=""      # Trading：部分実装でも並列可能
    FRONTEND_DEPENDS_ON=""     # Frontend：部分実装でも並列可能
    echo "🔧 Backend部分実装済み → Trading/Frontend と並列実行可能"
else
    # Backend未実装→強い依存関係（直列必要）
    TRADING_DEPENDS_ON="backend-director"      # Trading：Backend必須
    FRONTEND_DEPENDS_ON="backend-director"     # Frontend：Backend必須
    echo "🚨 Backend未実装 → Trading/Frontend はBackend完成後に実行（直列必要）"
fi

# Integration/Frontend間の依存関係（通常は並列実行可能）
echo "🔗 Integration ↔ Frontend：並列実行可能（依存関係なし）"

# 🎯 並列/直列実行判定システム（CEO戦略決定）
echo ""
echo "🎯 CEO戦略決定：並列/直列実行判定システム実行中..."

# 実行対象Director配列作成
EXECUTION_DIRECTORS=()
EXECUTION_INSTRUCTIONS=()
EXECUTION_DEPARTMENTS=()
EXECUTION_SCORES=()

# 各部門の実行判定・配列追加
if [ $BACKEND_PRIORITY_SCORE -gt 0 ]; then
    EXECUTION_DIRECTORS+=("backend-director")
    EXECUTION_INSTRUCTIONS+=("$BACKEND_DETAILED_INSTRUCTION")
    EXECUTION_DEPARTMENTS+=("Backend")
    EXECUTION_SCORES+=($BACKEND_PRIORITY_SCORE)
fi

if [ $TRADING_PRIORITY_SCORE -gt 0 ]; then
    EXECUTION_DIRECTORS+=("trading-flow-director")
    EXECUTION_INSTRUCTIONS+=("$TRADING_DETAILED_INSTRUCTION")
    EXECUTION_DEPARTMENTS+=("Trading")
    EXECUTION_SCORES+=($TRADING_PRIORITY_SCORE)
fi

if [ $INTEGRATION_PRIORITY_SCORE -gt 0 ]; then
    EXECUTION_DIRECTORS+=("integration-director")
    EXECUTION_INSTRUCTIONS+=("$INTEGRATION_DETAILED_INSTRUCTION")
    EXECUTION_DEPARTMENTS+=("Integration")
    EXECUTION_SCORES+=($INTEGRATION_PRIORITY_SCORE)
fi

if [ $FRONTEND_PRIORITY_SCORE -gt 0 ]; then
    EXECUTION_DIRECTORS+=("frontend-director")
    EXECUTION_INSTRUCTIONS+=("$FRONTEND_DETAILED_INSTRUCTION")
    EXECUTION_DEPARTMENTS+=("Frontend")
    EXECUTION_SCORES+=($FRONTEND_PRIORITY_SCORE)
fi

TOTAL_EXECUTION_COUNT=${#EXECUTION_DIRECTORS[@]}

# 🔄 CEO最終実行戦略判定
echo ""
echo "📊 CEO戦略決定結果："
echo "🛡️ 実装保護部門: $PROTECT_COUNT/4部門 (Over-Engineering防止継続)"
echo "🎯 実行対象部門: $TOTAL_EXECUTION_COUNT部門"
echo "📈 MVP完成度: $MVP_COMPLETION% (目標100%)"
echo ""

if [ $TOTAL_EXECUTION_COUNT -eq 0 ]; then
    echo "🎉 MVP完全実装状態確認（依存関係分析結果）"
    echo "✅ 全部門実装品質良好・追加作業不要"
    echo "🛡️ 実装保護モード有効・Over-Engineering防止"
    EXECUTION_STRATEGY="完成状態・指示不要"
elif [ $TOTAL_EXECUTION_COUNT -eq 1 ]; then
    echo "🎯 CEO戦略決定：単一Director指示実行"
    echo "📋 対象Director: ${EXECUTION_DIRECTORS[0]} (${EXECUTION_SCORES[0]}点)"
    echo "📋 理由: 実行対象1部門のみ"
    EXECUTION_STRATEGY="単一Director指示"
    HIGHEST_PRIORITY_DIRECTOR="${EXECUTION_DIRECTORS[0]}"
    HIGHEST_PRIORITY_INSTRUCTION="${EXECUTION_INSTRUCTIONS[0]}"
    HIGHEST_PRIORITY_DEPARTMENT="${EXECUTION_DEPARTMENTS[0]}"
    HIGHEST_PRIORITY_SCORE="${EXECUTION_SCORES[0]}"
else
    # 複数Director実行候補→依存関係による並列/直列判定
    echo "🔗 CEO戦略決定：複数Director実行候補 ($TOTAL_EXECUTION_COUNT部門)"
    echo "   依存関係分析による並列/直列判定実行中..."
    
    # 依存関係チェック→並列実行可能性判定
    PARALLEL_EXECUTION_POSSIBLE=true
    BLOCKING_DEPENDENCIES=""
    
    # Trading→Backend依存チェック
    if [[ " ${EXECUTION_DIRECTORS[@]} " =~ " trading-flow-director " ]] && [ "$TRADING_DEPENDS_ON" = "backend-director" ]; then
        if [[ " ${EXECUTION_DIRECTORS[@]} " =~ " backend-director " ]]; then
            PARALLEL_EXECUTION_POSSIBLE=false
            BLOCKING_DEPENDENCIES="Trading→Backend "
        fi
    fi
    
    # Frontend→Backend依存チェック
    if [[ " ${EXECUTION_DIRECTORS[@]} " =~ " frontend-director " ]] && [ "$FRONTEND_DEPENDS_ON" = "backend-director" ]; then
        if [[ " ${EXECUTION_DIRECTORS[@]} " =~ " backend-director " ]]; then
            PARALLEL_EXECUTION_POSSIBLE=false
            BLOCKING_DEPENDENCIES="${BLOCKING_DEPENDENCIES}Frontend→Backend "
        fi
    fi
    
    if [ "$PARALLEL_EXECUTION_POSSIBLE" = true ]; then
        echo "   ✅ 並列実行可能：依存関係なし→複数Director同時指示実行"
        echo "   🚀 並列実行対象: ${EXECUTION_DIRECTORS[*]}"
        EXECUTION_STRATEGY="並列実行・複数Director同時指示"
    else
        echo "   🔗 直列実行必要：依存関係検出 ($BLOCKING_DEPENDENCIES)"
        echo "   🎯 最優先Director選定→直列実行"
        
        # 最高優先度Director選定（直列実行用）
        HIGHEST_PRIORITY_SCORE=0
        HIGHEST_PRIORITY_INDEX=0
        for i in "${!EXECUTION_SCORES[@]}"; do
            if [ "${EXECUTION_SCORES[i]}" -gt "$HIGHEST_PRIORITY_SCORE" ]; then
                HIGHEST_PRIORITY_SCORE=${EXECUTION_SCORES[i]}
                HIGHEST_PRIORITY_INDEX=$i
            fi
        done
        
        HIGHEST_PRIORITY_DIRECTOR="${EXECUTION_DIRECTORS[$HIGHEST_PRIORITY_INDEX]}"
        HIGHEST_PRIORITY_INSTRUCTION="${EXECUTION_INSTRUCTIONS[$HIGHEST_PRIORITY_INDEX]}"
        HIGHEST_PRIORITY_DEPARTMENT="${EXECUTION_DEPARTMENTS[$HIGHEST_PRIORITY_INDEX]}"
        
        echo "   🏆 最優先Director: $HIGHEST_PRIORITY_DIRECTOR (${EXECUTION_SCORES[$HIGHEST_PRIORITY_INDEX]}点)"
        echo "   📋 ウォーターフォール2回目: 残り部門は次回実行で処理"
        EXECUTION_STRATEGY="直列実行・最優先Director指示"
    fi
fi

echo ""
echo "✅ CEO戦略的依存関係分析・並列/直列判断完了"
echo "📋 決定戦略: $EXECUTION_STRATEGY"

# 強制指示モード（引数で制御）
FORCE_DIRECTIVES="${1:-false}"

# Phase 3: CEO戦略実行・Director指示送信（並列/直列対応・v6.0革新機能）
echo ""
echo "🚀 Phase 3: CEO戦略実行・Director指示送信（並列/直列対応・v6.0革新機能）"
echo "────────────────────────────────────────────────"

# セッション確認
SESSION_NAME="arbitrage-assistant"
if ! tmux has-session -t $SESSION_NAME 2>/dev/null; then
    echo "❌ Haconiwaセッション未起動"
    echo "💡 起動: npm run haconiwa:start"
    exit 1
fi

# CEO戦略実行判定・指示送信分岐
if [ "$EXECUTION_STRATEGY" = "完成状態・指示不要" ] && [ "$FORCE_DIRECTIVES" != "force" ]; then
    echo "🎉 MVP完全実装状態確認"
    echo "✅ 全部門実装品質良好・追加作業不要"
    echo "🛡️ 実装保護モード有効・Over-Engineering防止"
    echo "📋 Director指示送信: 不要（完成状態）"
elif [ "$EXECUTION_STRATEGY" = "完成状態・指示不要" ] && [ "$FORCE_DIRECTIVES" = "force" ]; then
    echo "🔄 強制指示モード - Backend Director緊急チェック指示送信"
    EXECUTION_STRATEGY="単一Director指示"
    EXECUTION_DIRECTORS=("backend-director")
    EXECUTION_INSTRUCTIONS=("MVP基盤緊急品質チェック・Over-Engineering検出・品質保証実行")
    EXECUTION_DEPARTMENTS=("Backend")
    EXECUTION_SCORES=(50)
    TOTAL_EXECUTION_COUNT=1
fi

# Phase 3-1: CEO戦略実行・指示送信実行
if [ "$EXECUTION_STRATEGY" != "完成状態・指示不要" ]; then
    echo "🎯 CEO戦略実行: $EXECUTION_STRATEGY"
    echo ""
    
    if [ "$EXECUTION_STRATEGY" = "並列実行・複数Director同時指示" ]; then
        echo "🔄 【v6.0並列階層指示フロー】:"
        echo "1. CEO Supreme → 複数Director同時指示送信（実行中）"
        echo "2. 各Director → 並列でSpecialist指示送信（Director責任）"
        echo "3. 各Specialist → 並列でタスク実行・記録（Director管理下）"
        echo "4. 全完了後 → 次回ウォーターフォールで次段階処理"
        echo ""
        echo "📤 Phase 3-1: 複数Director並列指示送信開始..."
        echo "🚀 並列実行対象: $TOTAL_EXECUTION_COUNT部門同時実行"
        echo ""
        
        # 複数Director並列指示送信実行
        for i in "${!EXECUTION_DIRECTORS[@]}"; do
            DIRECTOR_ID="${EXECUTION_DIRECTORS[i]}"
            PRIORITY_TASK_DESC="${EXECUTION_INSTRUCTIONS[i]}"
            DEPARTMENT="${EXECUTION_DEPARTMENTS[i]}"
            SCORE="${EXECUTION_SCORES[i]}"
            
            # Director用ペイン取得
            case "$DIRECTOR_ID" in
                "backend-director") PANE="1.0" ;;
                "trading-flow-director") PANE="2.0" ;;
                "integration-director") PANE="3.0" ;;
                "frontend-director") PANE="4.0" ;;
                "devops-director") PANE="5.0" ;;
                *) 
                    echo "❌ エラー: 無効なDirector ID: $DIRECTOR_ID"
                    continue
                    ;;
            esac
            
            echo "📤 並列指示送信 $(($i + 1))/$TOTAL_EXECUTION_COUNT: $DIRECTOR_ID (ペイン $PANE)"
            echo "   🏷️ 担当部門: $DEPARTMENT"
            echo "   📊 優先度スコア: $SCORE点"
            echo "   📋 並列任務: $PRIORITY_TASK_DESC"
            
            # 並列Director戦略指示送信（Claude Code直接指示）
            PARALLEL_INSTRUCTION="【CEO Supreme並列戦略指示 v6.0並列実行版】$DIRECTOR_ID

💎 品質最優先方針: 時間制限なし・完璧性重視・妥協禁止
🎯 Claude Code実行品質・精度・完成度を最優先
🚀 CEO並列戦略: 複数Director同時実行 ($TOTAL_EXECUTION_COUNT部門並列)
🔍 実装内容詳細分析結果: $(eval echo \$${DEPARTMENT^^}_STRATEGIC_DECISION)

🎯 CEO並列戦略任務（並列実行・依存関係なし）:
$PRIORITY_TASK_DESC

🛡️【MVP絶対準拠・Over-Engineering完全防止】
• MVPシステム設計.md記載の必須実装のみ（100%準拠）
• forbidden-edits.md の禁止事項は死んでも実装禁止
• Over-Engineering絶対禁止・必要最小限実装
• 品質重視・時間制限なし・完璧性最優先

🏛️【並列階層責任システム v6.0】
• CEO → 複数Director並列指示完了（この指示・並列実行）
• Director → Specialist配下指示はあなたの判断・責任
• 手順: 実装計画検討→配下指示必要性判断→指示送信判断→実行管理
• 完了後: 次回ウォーターフォールで次段階処理
• 注意: 配下指示送信は慎重判断後のみ実行（自動実行禁止）

Director並列戦略実行開始してください。ultrathink"

            tmux send-keys -t "$SESSION_NAME:$PANE" "clear" Enter
            sleep 1
            tmux send-keys -t "$SESSION_NAME:$PANE" "$PARALLEL_INSTRUCTION" Enter
            sleep 1
            
            echo "   ✅ 並列指示送信完了: $DIRECTOR_ID"
        done
        
        echo ""
        echo "✅ 複数Director並列指示送信完了: $TOTAL_EXECUTION_COUNT部門同時実行開始"
    
    else
        # 単一Director指示（従来通り）
        echo "🔄 【v6.0直列階層指示フロー】:"
        echo "1. CEO Supreme → 最優先Director指示送信（実行中）"
        echo "2. Director → 自己判断でSpecialist指示送信（Director責任）"
        echo "3. Specialist → タスク実行・記録（Director管理下）"
        echo "4. 完了後 → 次回ウォーターフォールで次優先度Director処理"
        echo ""
        echo "📤 Phase 3-1: 最優先Director指示送信開始..."
        echo "🏆 選定結果: ${EXECUTION_DIRECTORS[0]} (${EXECUTION_SCORES[0]}点)"
        echo ""
        
        # 最優先Director指示送信実行（単一）
        DIRECTOR_ID="${EXECUTION_DIRECTORS[0]}"
        PRIORITY_TASK_DESC="${EXECUTION_INSTRUCTIONS[0]}"
        DEPARTMENT="${EXECUTION_DEPARTMENTS[0]}"
        SCORE="${EXECUTION_SCORES[0]}"
        
        # Director用ペイン取得
        case "$DIRECTOR_ID" in
            "backend-director") PANE="1.0" ;;
            "trading-flow-director") PANE="2.0" ;;
            "integration-director") PANE="3.0" ;;
            "frontend-director") PANE="4.0" ;;
            "devops-director") PANE="5.0" ;;
            *) 
                echo "❌ エラー: 無効なDirector ID: $DIRECTOR_ID"
                exit 1
                ;;
        esac

        echo "📤 最優先Director指示送信: $DIRECTOR_ID (ペイン $PANE)"
        echo "   🏷️ 担当部門: $DEPARTMENT"
        echo "   📊 優先度スコア: $SCORE点"
        echo "   🎯 戦略判断: $(eval echo \$${DEPARTMENT^^}_STRATEGIC_DECISION)"
        echo "   📋 最優先任務: $PRIORITY_TASK_DESC"
        echo ""
        
        # 最優先Director戦略指示送信（Claude Code直接指示）
        DIRECT_INSTRUCTION="【CEO Supreme最優先戦略指示 v6.0直列実行版】$DIRECTOR_ID

💎 品質最優先方針: 時間制限なし・完璧性重視・妥協禁止
🎯 Claude Code実行品質・精度・完成度を最優先
🏆 CEO優先度評価: 最優先Director選定 ($SCORE点/$DEPARTMENT)
🔍 実装内容詳細分析結果: $(eval echo \$${DEPARTMENT^^}_STRATEGIC_DECISION)

🎯 CEO最優先戦略任務（直列実行・優先度評価結果）:
$PRIORITY_TASK_DESC

🛡️【MVP絶対準拠・Over-Engineering完全防止】
• MVPシステム設計.md記載の必須実装のみ（100%準拠）
• forbidden-edits.md の禁止事項は死んでも実装禁止
• Over-Engineering絶対禁止・必要最小限実装
• 品質重視・時間制限なし・完璧性最優先

🏛️【直列階層責任システム v6.0】
• CEO → 最優先Director指示完了（この指示・他Director指示なし）
• Director → Specialist配下指示はあなたの判断・責任
• 手順: 実装計画検討→配下指示必要性判断→指示送信判断→実行管理
• 完了後: 次回ウォーターフォールで次優先度Director処理
• 注意: 配下指示送信は慎重判断後のみ実行（自動実行禁止）

Director最優先戦略実行開始してください。ultrathink"

        tmux send-keys -t "$SESSION_NAME:$PANE" "clear" Enter
        sleep 1
        tmux send-keys -t "$SESSION_NAME:$PANE" "$DIRECT_INSTRUCTION" Enter
        sleep 2
        
        echo "✅ 最優先Director指示送信完了: $DIRECTOR_ID"
    fi
else
    echo "📋 Director指示送信: なし（MVP完成状態確認済み）"
fi

# Phase 3-2: Director自律判断フェーズ（CEO戦略実行完了）
echo ""
echo "📤 Phase 3-2: Director自律判断フェーズ"
if [ "$EXECUTION_STRATEGY" = "並列実行・複数Director同時指示" ]; then
    echo "🏛️ CEO Supreme → 複数Director並列指示送信完了"
    echo "⚠️ 以降は実行対象Director各自が独立判断・責任で実行"
    echo "🚀 並列実行対象: ${EXECUTION_DIRECTORS[*]}"
    echo "🎯 Director判断手順: 実装計画検討→配下指示必要性判断→慎重実行"
    echo "🚨 重要: 配下指示送信は自動実行せず、慎重な判断後のみ実行"
    echo "📋 ウォーターフォール: 全完了後に次回実行で次段階処理"
elif [ "$EXECUTION_STRATEGY" = "単一Director指示" ] || [ "$EXECUTION_STRATEGY" = "直列実行・最優先Director指示" ]; then
    echo "🏛️ CEO Supreme → 最優先Director指示送信完了"
    echo "⚠️ 以降は${EXECUTION_DIRECTORS[0]}独立判断・責任で実行"
    echo "🎯 Director判断手順: 実装計画検討→配下指示必要性判断→慎重実行"
    echo "🚨 重要: 配下指示送信は自動実行せず、慎重な判断後のみ実行"
    echo "📋 ウォーターフォール: 次回実行で次優先度Director処理"
else
    echo "🏛️ CEO Supreme → Director指示送信なし（MVP完成状態）"
    echo "✅ 全部門実装完了・Over-Engineering防止継続"
fi
echo ""
echo "✅ CEO階層責任完了 - Director自律実行に完全移管"

# Phase 4: CEO Supreme戦略実行完了サマリー（v6.0並列/直列対応版）
echo ""
echo "✅ Phase 4: CEO Supreme v6.0戦略実行完了サマリー"
echo "────────────────────────────────────────────────"

EXECUTION_TIME=$(date '+%Y-%m-%d %H:%M:%S')

echo ""
if [ "$EXECUTION_STRATEGY" = "並列実行・複数Director同時指示" ]; then
    echo "🎯 CEO Supreme v6.0-optimized 依存関係分析・並列実行完了"
elif [ "$EXECUTION_STRATEGY" = "直列実行・最優先Director指示" ] || [ "$EXECUTION_STRATEGY" = "単一Director指示" ]; then
    echo "🎯 CEO Supreme v6.0-optimized 優先度評価・直列実行完了"
else
    echo "🎯 CEO Supreme v6.0-optimized 完成状態確認完了"
fi
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "実行時刻: $EXECUTION_TIME"
echo ""
echo "📊 依存関係分析・戦略実行結果サマリー:"
echo "🛡️ 実装保護部門: $PROTECT_COUNT/4部門（完全実装済み・変更禁止）"

if [ "$EXECUTION_STRATEGY" = "並列実行・複数Director同時指示" ]; then
    echo "🚀 並列指示送信: $TOTAL_EXECUTION_COUNT部門（${EXECUTION_DIRECTORS[*]}）"
elif [ "$EXECUTION_STRATEGY" = "直列実行・最優先Director指示" ] || [ "$EXECUTION_STRATEGY" = "単一Director指示" ]; then
    echo "🎯 最優先指示送信: 1部門（${EXECUTION_DIRECTORS[0]} - ${EXECUTION_SCORES[0]}点）"
else
    echo "🎯 指示送信: 0部門（MVP完成状態）"
fi
echo "📈 MVP完成度: $(( (PROTECT_COUNT * 100) / 4 ))%"
echo ""
echo "🔍 各部門優先度評価結果:"
echo "   🗄️ Backend: $BACKEND_STRATEGIC_DECISION (優先度: ${BACKEND_PRIORITY_SCORE:-0}点)"
echo "   ⚡ Trading: $TRADING_STRATEGIC_DECISION (優先度: ${TRADING_PRIORITY_SCORE:-0}点)"
echo "   🔌 Integration: $INTEGRATION_STRATEGIC_DECISION (優先度: ${INTEGRATION_PRIORITY_SCORE:-0}点)"
echo "   🎨 Frontend: $FRONTEND_STRATEGIC_DECISION (優先度: ${FRONTEND_PRIORITY_SCORE:-0}点)"
echo ""

if [ "$EXECUTION_STRATEGY" = "完成状態・指示不要" ]; then
    echo "🎉 MVP完全実装状態確認（依存関係分析結果）"
    echo "✅ 全部門実装品質良好・追加作業不要"
    echo "🛡️ 実装保護モード有効・Over-Engineering防止"
    echo "🔍 実装内容詳細分析により完成確認"
elif [ "$EXECUTION_STRATEGY" = "並列実行・複数Director同時指示" ]; then
    echo "📈 MVP完成指向実行中（並列戦略・効率最大化フロー）"
    echo "• CEO → 複数Director並列指示送信: $TOTAL_EXECUTION_COUNT部門同時実行"
    echo "• 並列実行対象: ${EXECUTION_DIRECTORS[*]}"
    echo "• 既存実装保護: $PROTECT_COUNT部門"
    echo "• 依存関係分析: 並列実行可能性確認済み"
    echo "• 実装内容詳細分析: 全4部門完了"
    echo "• Director責任移管: 全実行対象Directorに並列移管完了"
    echo ""
    echo "🔄 【v6.0並列階層システム】CEO責任完了:"
    echo ""
    echo "✅ 【完了】実装内容詳細読み込み・深度分析"
    echo "✅ 【完了】依存関係分析・並列実行可能性判定"
    echo "✅ 【完了】CEO Supreme → 複数Director並列指示送信"
    echo "⏳ 【移管】各Director → Specialist指示送信（Director判断）"
    echo "⏳ 【移管】Tasks Directory記録・管理（Director責任）"
    echo "⏳ 【移管】各Specialist実行管理（Director管理下）"
    echo "📋 【次回】全完了後にウォーターフォール次段階処理"
else
    echo "📈 MVP完成指向実行中（優先度戦略・直列階層指示フロー）"
    echo "• CEO → 最優先Director指示送信: 1部門完了 (${EXECUTION_DEPARTMENTS[0]})"
    echo "• 既存実装保護: $PROTECT_COUNT部門"
    echo "• 実装内容詳細分析: 全4部門完了"
    echo "• 優先度評価システム: MVP依存関係考慮済み"
    echo "• Director責任移管: ${EXECUTION_DIRECTORS[0]} に移管完了"
    echo ""
    echo "🔄 【v6.0直列階層システム】CEO責任完了:"
    echo ""
    echo "✅ 【完了】実装内容詳細読み込み・深度分析"
    echo "✅ 【完了】優先度評価・戦略判断"
    echo "✅ 【完了】CEO Supreme → 最優先Director指示送信（直列実行）"
    echo "⏳ 【移管】Director → Specialist指示送信（Director判断）"
    echo "⏳ 【移管】Tasks Directory記録・管理（Director責任）"
    echo "⏳ 【移管】Specialist実行管理（Director管理下）"
    echo "📋 【次回】ウォーターフォール2回目で次優先度Director処理"
fi

echo ""
echo "🚀 CEO Supreme v6.0-optimized 依存関係分析・並列/直列戦略システム特徴:"
echo "• 実装内容詳細読み込み: 実際のファイル内容を完全分析"
echo "• 依存関係分析システム: MVP依存関係を動的分析・並列可能性判定"
echo "• 並列/直列実行判定: 依存関係なし→並列実行、依存関係あり→直列実行"
echo "• 動的指示生成: 実装状況に応じた適切な指示の動的生成"
echo "• 明確な階層: CEO→Director指示（CEO責任範囲）"
echo "• Director自律: Director→Specialist指示判断（Director責任）"
echo "• Tasks Directory: Director管理下で記録・追跡・管理"
echo "• MVP絶対準拠: Over-Engineering完全防止"
echo "• 実装保護: 完成済み変更防止・品質保護"
echo "• 一回実行特化: 進捗監視なし・完璧指示のみ"
echo "• 時間制限なし: 品質最優先・完璧性重視・妥協禁止"
echo "• ウォーターフォール方式: 並列/直列実行でMVP依存関係を考慮"
echo ""
echo "✅ CEO Supreme v6.0-optimized 依存関係分析・並列/直列戦略フロー確立完了"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

# 通知
if [ "$EXECUTION_STRATEGY" = "並列実行・複数Director同時指示" ]; then
    osascript -e 'display notification "CEO Supreme v6.0並列Director指示完了" with title "ArbitrageAssistant" sound name "Glass"' 2>/dev/null || true
    NOTIFICATION_MESSAGE="並列Director ($TOTAL_EXECUTION_COUNT部門) 指示送信完了"
elif [ "$EXECUTION_STRATEGY" = "直列実行・最優先Director指示" ] || [ "$EXECUTION_STRATEGY" = "単一Director指示" ]; then
    osascript -e 'display notification "CEO Supreme v6.0最優先Director指示完了" with title "ArbitrageAssistant" sound name "Glass"' 2>/dev/null || true
    NOTIFICATION_MESSAGE="最優先Director (${EXECUTION_DIRECTORS[0]}) 指示送信完了"
else
    osascript -e 'display notification "CEO Supreme v6.0 MVP完成状態確認" with title "ArbitrageAssistant" sound name "Glass"' 2>/dev/null || true
    NOTIFICATION_MESSAGE="MVP完成状態確認・指示送信不要"
fi

echo ""
echo "🎯 CEO Supreme v6.0-optimized、依存関係分析・並列/直列戦略システムでMVP完成をリードしました。"
if [ "$EXECUTION_STRATEGY" = "並列実行・複数Director同時指示" ]; then
    echo "実装内容詳細分析→依存関係分析→複数Director並列指示送信 ($TOTAL_EXECUTION_COUNT部門) が完了しました。"
    echo "以降は実行対象Director各自の自己判断に移管し、全完了後に次回ウォーターフォールで次段階処理を行います。"
elif [ "$EXECUTION_STRATEGY" = "直列実行・最優先Director指示" ] || [ "$EXECUTION_STRATEGY" = "単一Director指示" ]; then
    echo "実装内容詳細分析→優先度評価→最優先Director (${EXECUTION_DIRECTORS[0]}) 指示送信が完了しました。"
    echo "以降は ${EXECUTION_DIRECTORS[0]} の自己判断に移管し、完了後に次回ウォーターフォールで次優先度Director処理を行います。"
else
    echo "実装内容詳細分析→依存関係分析により、MVP完成状態を確認しました。"
    echo "全部門実装完了・追加作業不要・Over-Engineering防止継続中です。"
fi
echo ""
echo "✅ CEO Supreme 依存関係分析・並列/直列戦略実行完了 - 効率最大化・ウォーターフォール式"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""
echo "CEO Supreme v6.0-optimized 並列/直列戦略実行完了。ultrathink"